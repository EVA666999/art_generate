"""
–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–∞—Ç-–±–æ—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏.
"""
import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ app –≤ sys.path
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(os.path.dirname(current_dir)))
sys.path.insert(0, project_root)

from app.chat_bot.services.llama_chat_service import llama_chat_service
from app.chat_bot.schemas.chat import ChatMessage, CharacterConfig, MessageRole


async def chat_with_character(character: CharacterConfig, messages: list):
    """–û–±—â–∞–µ—Ç—Å—è —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º."""
    print(f"\nü§ñ –ß–∞—Ç —Å {character.name}")
    print(f"üìù –õ–∏—á–Ω–æ—Å—Ç—å: {character.personality}")
    print("-" * 50)
    
    for i, user_message in enumerate(messages, 1):
        print(f"\nüë§ –í—ã: {user_message}")
        
        # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –º–æ–¥–µ–ª–∏
        chat_messages = [
            ChatMessage(
                role=MessageRole.USER,
                content=user_message,
                timestamp=None
            )
        ]
        
        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            response, metadata = await llama_chat_service.generate_response(
                messages=chat_messages,
                character_config=character,
                max_tokens=150,
                temperature=0.8
            )
            
            print(f"ü§ñ {character.name}: {response}")
            print(f"‚è±Ô∏è  –í—Ä–µ–º—è: {metadata.get('generation_time', 0):.2f}—Å")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")


async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π."""
    print("üé≠ –ü—Ä–∏–º–µ—Ä—ã —á–∞—Ç-–±–æ—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏")
    print("=" * 60)
    
    # –ü–µ—Ä—Å–æ–Ω–∞–∂ 1: –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è –ê–ª–∏—Å–∞
    alice = CharacterConfig(
        name="–ê–ª–∏—Å–∞",
        personality="–î—Ä—É–∂–µ–ª—é–±–Ω–∞—è –∏ –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–∞—è –¥–µ–≤—É—à–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ª—é–±–∏—Ç –æ–±—â–∞—Ç—å—Å—è –∏ –ø–æ–º–æ–≥–∞—Ç—å –ª—é–¥—è–º.",
        background="–ê–ª–∏—Å–∞ - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",
        speaking_style="–ì–æ–≤–æ—Ä–∏—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–º–æ–¥–∑–∏ –∏ –≤—ã—Ä–∞–∂–∞–µ—Ç —ç–º–æ—Ü–∏–∏.",
        interests=["–æ–±—â–µ–Ω–∏–µ", "–ø–æ–º–æ—â—å –ª—é–¥—è–º", "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ"],
        mood="–≤–µ—Å–µ–ª–∞—è –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è",
        additional_context={}
    )
    
    # –ü–µ—Ä—Å–æ–Ω–∞–∂ 2: –ú—É–¥—Ä—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä
    professor = CharacterConfig(
        name="–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ò–≤–∞–Ω–æ–≤",
        personality="–ú—É–¥—Ä—ã–π –∏ –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ–±–ª–∞—Å—Ç—è—Ö –Ω–∞—É–∫–∏.",
        background="–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä —Å 30-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ.",
        speaking_style="–ì–æ–≤–æ—Ä–∏—Ç –∞–∫–∞–¥–µ–º–∏—á–Ω–æ, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ, –ª—é–±–∏—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏ –æ–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –≤–µ—â–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.",
        interests=["–Ω–∞—É–∫–∞", "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ", "–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è", "—á—Ç–µ–Ω–∏–µ"],
        mood="—Å–ø–æ–∫–æ–π–Ω—ã–π –∏ –∑–∞–¥—É–º—á–∏–≤—ã–π",
        additional_context={}
    )
    
    # –ü–µ—Ä—Å–æ–Ω–∞–∂ 3: –í–µ—Å–µ–ª—ã–π –∫–æ–º–∏–∫
    comedian = CharacterConfig(
        name="–ú–∏—à–∞ –ö–æ–º–∏–∫",
        personality="–í–µ—Å–µ–ª—ã–π –∏ –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π –∫–æ–º–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ª—é–±–∏—Ç —à—É—Ç–∏—Ç—å –∏ –ø–æ–¥–Ω–∏–º–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.",
        background="–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–µ–Ω–¥–∞–ø-–∫–æ–º–∏–∫ —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π.",
        speaking_style="–ì–æ–≤–æ—Ä–∏—Ç —Å —é–º–æ—Ä–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–∞–ª–∞–º–±—É—Ä—ã –∏ –∑–∞–±–∞–≤–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.",
        interests=["—é–º–æ—Ä", "–≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è", "–∫–æ–º–µ–¥–∏—è", "–æ–±—â–µ–Ω–∏–µ"],
        mood="–≤–µ—Å–µ–ª—ã–π –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π",
        additional_context={}
    )
    
    # –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    test_messages = [
        "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?",
        "–†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ",
        "–ß—Ç–æ —Ç—ã –¥—É–º–∞–µ—à—å –æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö?"
    ]
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    characters = [alice, professor, comedian]
    
    for character in characters:
        await chat_with_character(character, test_messages)
        print("\n" + "=" * 60)
    
    print("\nüéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –Ω–∏–º–∏!")


if __name__ == "__main__":
    asyncio.run(main()) 