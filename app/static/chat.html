<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чат с персонажами</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            background: white;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .generate-image-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-left: 10px;
        }

        .generate-image-button:hover {
            transform: translateY(-2px);
        }

        .generate-image-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .info-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .info-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-section p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .character-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .character-item {
            padding: 12px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .character-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
        }

        .character-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .character-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .character-description {
            font-size: 12px;
            opacity: 0.8;
        }


        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: auto;
        }

        .quick-action-btn {
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .quick-action-btn:hover {
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }
        
        /* Стили для модального окна */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .modal-content p {
            margin-bottom: 15px;
            color: #666;
        }
        
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 20px;
            font-family: inherit;
        }

        .modal-content textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: 1px solid #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }

        .btn-google {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .btn-google:hover {
            background: #3367d6;
        }

        /* Стили для кнопок редактирования */
        .character-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .btn-edit {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-edit:hover {
            background: #218838;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .character-item {
            position: relative;
        }

        .character-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        /* Стили для модального окна редактирования */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .edit-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="info-section">
                <h3>Доступные персонажи</h3>
                <div id="characterList" class="character-list">
                    <!-- Персонажи будут загружены автоматически -->
                </div>
            </div>

            <div class="info-section">
                <h3>Информация</h3>
                <p id="modelInfo">Загрузка...</p>
                </div>

            <div class="quick-actions">
                <button class="quick-action-btn" onclick="chatApp.sendQuickMessage('Привет! Как дела?')">Привет!</button>
                <button class="quick-action-btn" onclick="chatApp.sendQuickMessage('Расскажи о себе')">О себе</button>
                <button class="quick-action-btn" onclick="chatApp.continueStory()">Продолжить историю</button>
                <button class="quick-action-btn" onclick="chatApp.openPaidGallery()">💎 Платная галерея</button>
                <button class="quick-action-btn" onclick="showShopModal()">🛒 Магазин</button>
                <button class="quick-action-btn" onclick="showCreateCharacterModal()">👤 Создать персонажа (10💰)</button>
                <button class="quick-action-btn" onclick="chatApp.clearChat()">Очистить чат</button>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div>
                        <h1 id="chatTitle">Чат с Anna</h1>
                        <p>Простой чат без стриминга - прямые ответы от модели</p>
                    </div>
                    <div id="authButtons" style="display: none;">
                        <button id="loginBtn" class="btn btn-primary" onclick="showLoginModal()" style="margin-right: 8px;">
                            Войти
                        </button>
                        <button id="registerBtn" class="btn btn-secondary" onclick="showRegisterModal()">
                            Регистрация
                        </button>
                    </div>
                    <div id="userButtons" style="display: none;">
                        <button id="profileBtn" class="btn btn-primary" onclick="showProfileModal()" style="margin-right: 8px;">
                            👤 <span id="usernameDisplay"></span> | 💰 <span id="coinsDisplay">0</span>
                        </button>
                        <button id="clearHistoryBtn" class="btn btn-danger" onclick="chatApp.clearChatHistory()" style="margin-right: 8px;">
                            🗑️ Очистить историю
                        </button>
                        <button id="logoutBtn" class="btn btn-secondary" onclick="logout()">
                            Выйти
                        </button>
                    </div>
                </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-content">
                        Привет! Я Anna. Как дела? 😊
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
                Генерируется ответ...
        </div>

            <div class="error" id="error"></div>

        <div class="chat-input">
                <input type="text" id="messageInput" class="message-input" placeholder="Введите сообщение...">
                <button id="sendButton" class="send-button">Отправить</button>
                <button id="generateImageButton" class="generate-image-button">🎨 Изображение</button>
            </div>
        </div>
    </div>

    <!-- Модальные окна авторизации -->
    <div id="loginModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Вход в систему</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль:</label>
                    <input type="password" id="loginPassword" name="password" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Войти</button>
                    <button type="button" class="btn btn-secondary" onclick="hideLoginModal()">Отмена</button>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <div style="margin: 10px 0; color: #666;">или</div>
                    <button type="button" class="btn btn-google" onclick="loginWithGoogle()">
                        <img src="https://developers.google.com/identity/images/g-logo.png" 
                             style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                        Войти через Google
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Регистрация</h3>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Пароль (минимум 8 символов, заглавные, строчные буквы и цифры):</label>
                    <input type="password" id="registerPassword" name="password" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
                    <button type="button" class="btn btn-secondary" onclick="hideRegisterModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <div id="verificationModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Подтверждение email</h3>
            <p>На ваш email отправлен код подтверждения. Введите его ниже:</p>
            <form id="verificationForm">
                <div class="form-group">
                    <label for="verificationCode">Код подтверждения:</label>
                    <input type="text" id="verificationCode" name="code" required maxlength="6" placeholder="6-значный код">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Подтвердить</button>
                    <button type="button" class="btn btn-secondary" onclick="hideVerificationModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Личный кабинет</h3>
            <div id="profileInfo">
                <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                <p><strong>ID:</strong> <span id="profileId"></span></p>
                <p><strong>Статус:</strong> <span id="profileStatus"></span></p>
                <p><strong>💰 Монеты:</strong> <span id="profileCoins"></span></p>
                <p><strong>Дата регистрации:</strong> <span id="profileCreatedAt"></span></p>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="hideProfileModal()">Закрыть</button>
                <button class="btn btn-secondary" onclick="logout()">Выйти</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно магазина -->
    <div id="shopModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <h3>🛒 Магазин подписок</h3>
            
            <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                <h4 style="margin: 0 0 10px 0; color: #28a745;">💡 Текущая система кредитов</h4>
                <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                    • <strong>1 сообщение</strong> = 2 кредита<br>
                    • <strong>1 генерация фото</strong> = 30 кредитов<br>
                    • <strong>Создание персонажа</strong> = 10 кредитов
                </p>
            </div>

            <div class="subscription-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                    БЕСПЛАТНО
                </div>
                <h4 style="margin: 0 0 15px 0; font-size: 24px;">Base</h4>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ 100 кредитов в месяц</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ 10 генераций фото в месяц</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ Максимум 100 символов в сообщении</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">❌ История сообщений не сохраняется</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 14px; opacity: 0.9;">Кредиты обновляются каждый месяц автоматически</div>
                </div>
                <button class="btn btn-primary" onclick="activateSubscription('base')" style="background: white; color: #667eea; font-weight: bold; padding: 12px 25px;">
                    Активировать подписку Base
                </button>
            </div>

            <div class="subscription-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                    РЕКОМЕНДУЕТСЯ
                </div>
                <h4 style="margin: 0 0 15px 0; font-size: 24px;">Standard</h4>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ 2000 кредитов в месяц</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ Максимум 200 символов в сообщении</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ Сохраняется история сообщений</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 14px; opacity: 0.9;">Кредиты обновляются каждый месяц автоматически</div>
                </div>
                <button class="btn btn-primary" onclick="activateSubscription('standard')" style="background: white; color: #28a745; font-weight: bold; padding: 12px 25px;">
                    Активировать подписку Standard
                </button>
            </div>

            <div class="subscription-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                    ПРЕМИУМ
                </div>
                <h4 style="margin: 0 0 15px 0; font-size: 24px;">Premium</h4>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ 6000 кредитов в месяц</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ Максимум 300 символов в сообщении</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">✅ Сохраняется история сообщений</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 14px; opacity: 0.9;">Кредиты обновляются каждый месяц автоматически</div>
                </div>
                <button class="btn btn-primary" onclick="activateSubscription('premium')" style="background: white; color: #ff6b6b; font-weight: bold; padding: 12px 25px;">
                    Активировать подписку Premium
                </button>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">📊 Статистика использования</h4>
                <div id="subscriptionStats" style="font-size: 14px;">
                    <div>Использовано кредитов в этом месяце: <span id="usedCredits">0</span> / <span id="totalCredits">100</span></div>
                    <div>Использовано генераций фото: <span id="usedPhotos">0</span> / <span id="totalPhotos">10</span></div>
                    <div>Осталось дней до обновления: <span id="daysLeft">30</span></div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideShopModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно создания персонажа -->
    <div id="createCharacterModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3>👤 Создать персонажа</h3>
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                <h4 style="margin: 0 0 10px 0; color: #007bff;">💡 Hint!</h4>
                <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                    For quality character creation, follow this format:<br>
                    <strong>Character Name</strong> - enter character name<br>
                    1. <strong>Personality and Character</strong> - describe character personality<br>
                    2. <strong>Role-playing Situation</strong> - what situation the character is in<br>
                    3. <strong>Instructions</strong> - how the character should behave<br>
                    4. <strong>Response Style</strong> (optional) - speech features<br>
                    5. <strong>Appearance</strong> (for photos) - character appearance description<br>
                    6. <strong>Location</strong> (for photos) - where the character is located
                </p>
            </div>
            
            <form id="createCharacterForm">
                <div class="form-group">
                    <label for="characterName">Character Name:</label>
                    <input type="text" id="characterName" name="name" required placeholder="For example: Anna">
                </div>
                
                <div class="form-group">
                    <label for="characterPersonality">1. Personality and Character:</label>
                    <textarea id="characterPersonality" name="personality" required 
                              placeholder="Describe the character's personality, appearance, main character traits..."
                              rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="characterSituation">2. Role-playing Situation:</label>
                    <textarea id="characterSituation" name="situation" required 
                              placeholder="What situation is the character in? What's happening in their world?"
                              rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="characterInstructions">3. Instructions:</label>
                    <textarea id="characterInstructions" name="instructions" required 
                              placeholder="How should the character behave? What rules to follow?"
                              rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="characterStyle">4. Response Style (optional):</label>
                    <textarea id="characterStyle" name="style" 
                              placeholder="Speech features, communication style, favorite phrases..."
                              rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="characterAppearance">5. Character Appearance (for photo generation):</label>
                    <textarea id="characterAppearance" name="appearance" 
                              placeholder="Describe the character's appearance: hair color, eyes, clothing, features..."
                              rows="2"></textarea>
                    <small style="color: #666; font-size: 12px;">💡 This field directly affects image generation!</small>
                </div>
                
                <div class="form-group">
                    <label for="characterLocation">6. Location (for photo generation):</label>
                    <textarea id="characterLocation" name="location" 
                              placeholder="Describe the place where the character is: room, street, nature..."
                              rows="2"></textarea>
                    <small style="color: #666; font-size: 12px;">💡 This field directly affects image generation!</small>
                </div>
                
                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                    <strong>💰 Стоимость:</strong> 10 монет
                    <span id="userCoinsInfo" style="float: right;"></span>
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Создать персонажа (10💰)</button>
                    <button type="button" class="btn btn-secondary" onclick="hideCreateCharacterModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно требования авторизации -->
    <div id="authRequiredModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>🔐 Требуется авторизация</h3>
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">💡 Для использования чата необходимо войти в систему</h4>
                <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                    Чтобы отправлять сообщения персонажам и генерировать изображения, вам нужно:
                </p>
                <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                    <li>Зарегистрироваться в системе</li>
                    <li>Или войти в существующий аккаунт</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="hideAuthRequiredModal(); showRegisterModal();">Зарегистрироваться</button>
                <button class="btn btn-secondary" onclick="hideAuthRequiredModal(); showLoginModal();">Войти</button>
                <button class="btn btn-outline" onclick="hideAuthRequiredModal();">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.generateImageButton = document.getElementById('generateImageButton');
                this.loading = document.getElementById('loading');
                this.error = document.getElementById('error');
                this.characterList = document.getElementById('characterList');
                this.modelInfo = document.getElementById('modelInfo');
                this.chatTitle = document.getElementById('chatTitle');
                
                this.messages = [];
                this.sessionId = 'chat_' + Date.now();
                this.currentCharacter = 'anna';
                this.currentCharacterData = null; // Данные текущего персонажа из БД
                
                // Переменные для истории чата
                this.canSaveHistory = false;
                this.historyEnabled = false;
                this.generationSettings = null; // Настройки генерации
                this.fallbackSettings = {}; // Кэш для fallback значений
                
                this.setupEventListeners();
                // Не вызываем loadInfo() сразу - это будет сделано в checkAuth()
            }
            
            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.generateImageButton.addEventListener('click', () => this.sendMessageWithImage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }
            
            async loadInfo() {
                try {
                    // Загружаем информацию о персонажах
                    const charResponse = await fetch('/api/v1/characters/');
                    if (charResponse.ok) {
                        const data = await charResponse.json();
                        console.log('Получены персонажи:', data);
                        // API возвращает массив напрямую, а не объект с полем characters
                        this.updateCharacterList(data);
                    } else {
                        console.error('Failed to fetch characters:', charResponse.status, charResponse.statusText);
                        this.characterList.innerHTML = '<p>Ошибка загрузки персонажей (HTTP ' + charResponse.status + ')</p>';
                        
                        // Попробуем альтернативный эндпоинт
                        try {
                            const altResponse = await fetch('/api/characters/');
                            if (altResponse.ok) {
                                const altData = await altResponse.json();
                                console.log('Получены персонажи из альтернативного эндпоинта:', altData);
                                this.updateCharacterList(altData);
                            }
                        } catch (altError) {
                            console.error('Alternative endpoint also failed:', altError);
                        }
                    }
                } catch (error) {
                    console.error('Ошибка загрузки персонажей:', error);
                    this.characterList.innerHTML = '<p>Ошибка загрузки персонажей</p>';
                }

                // Проверяем права на сохранение истории чата
                if (authToken && currentUser) {
                    await this.checkHistoryPermissions();
                }

                try {
                    // Загружаем информацию о моделях
                    const modelResponse = await fetch('/api/v1/models/');
                    if (modelResponse.ok) {
                        const models = await modelResponse.json();
                        this.modelInfo.textContent = `${models.length} модель(ей) доступно`;
                    }
                } catch (error) {
                    console.error('Ошибка загрузки моделей:', error);
                    this.modelInfo.textContent = 'Ошибка загрузки моделей';
                }
                
                // Загружаем настройки генерации
                await this.loadGenerationSettings();
            }
            
            async loadGenerationSettings() {
                try {
                    const response = await fetch('/api/v1/generation-settings/');
                    if (response.ok) {
                        this.generationSettings = await response.json();
                        console.log('Настройки генерации загружены:', this.generationSettings);
                    } else {
                        console.error('Ошибка загрузки настроек генерации');
                        // Получаем fallback значения из API
                        await this.loadFallbackSettings();
                    }
                } catch (error) {
                    console.error('Ошибка загрузки настроек генерации:', error);
                    // Получаем fallback значения из API
                    await this.loadFallbackSettings();
                }
            }

            async loadFallbackSettings() {
                try {
                    // Сначала пробуем получить fallback настройки из API
                    const response = await fetch('/api/v1/fallback-settings/');
                    if (response.ok) {
                        this.generationSettings = await response.json();
                        console.log('Fallback настройки загружены из API:', this.generationSettings);
                    } else {
                        throw new Error('Fallback API недоступен');
                    }
                } catch (error) {
                    console.error('Ошибка загрузки fallback настроек:', error);
                    // Последний резерв - получаем значения из API
                    try {
                        const response = await fetch('/api/v1/fallback-settings/');
                        if (response.ok) {
                            this.generationSettings = await response.json();
                        } else {
                            throw new Error('API недоступен');
                        }
                    } catch (error) {
                        console.error('Критическая ошибка загрузки настроек:', error);
                        // Если совсем ничего не работает, используем пустые значения
                        this.generationSettings = {
                            steps: null,
                            width: null,
                            height: null,
                            cfg_scale: null,
                            sampler_name: null,
                            negative_prompt: null
                        };
                    }
                }
            }

            async getFallbackValue(key) {
                // Получаем значения из API, никакого хардкода!
                if (Object.keys(this.fallbackSettings).length === 0) {
                    try {
                        const response = await fetch('/api/v1/fallback-settings/');
                        if (response.ok) {
                            this.fallbackSettings = await response.json();
                        }
                    } catch (error) {
                        console.error('Ошибка получения fallback значений:', error);
                    }
                }
                return this.fallbackSettings[key] || null;
            }

            updateCharacterList(characters) {
                console.log('DEBUG: updateCharacterList called with currentUser:', currentUser);
                console.log('DEBUG: Characters received:', characters);
                
                // Очищаем список
                this.characterList.innerHTML = '';
                
                if (!characters || !Array.isArray(characters)) {
                    console.error('Characters is not an array:', characters);
                    this.characterList.innerHTML = '<p>Нет доступных персонажей</p>';
                    return;
                }
                
                if (characters.length === 0) {
                    console.log('No characters found');
                    this.characterList.innerHTML = '<p>Нет доступных персонажей</p>';
                    return;
                }
                
                // Добавляем персонажей
                characters.forEach((char, index) => {
                    try {
                        const characterItem = document.createElement('div');
                        characterItem.className = 'character-item';
                        if (index === 0) {
                            characterItem.classList.add('active');
                            this.currentCharacter = char.name;
                        }
                        
                        // Используем данные из API с fallback значениями
                        const displayName = char.display_name || char.name || 'Персонаж';
                        const description = char.description || 'Готов к общению';
                        
                        // Проверяем права на редактирование
                        const canEdit = currentUser && (char.user_id === currentUser.id || currentUser.is_admin === true);
                        
                        // Отладочная информация
                        console.log(`DEBUG: Character ${char.name}:`, {
                            char_user_id: char.user_id,
                            currentUser_id: currentUser?.id,
                            currentUser_is_admin: currentUser?.is_admin,
                            currentUser_is_admin_type: typeof currentUser?.is_admin,
                            canEdit: canEdit
                        });
                        
                        characterItem.innerHTML = `
                            <div class="character-name">${displayName}</div>
                            <div class="character-description">${description}</div>
                            ${canEdit ? `
                                <div class="character-actions">
                                    <button class="btn-edit" onclick="event.stopPropagation(); editCharacter('${char.name}')" title="Редактировать персонажа">
                                        ✏️ Редактировать
                                    </button>
                                    <button class="btn-delete" onclick="event.stopPropagation(); deleteCharacter('${char.name}')" title="Удалить персонажа">
                                        🗑️ Удалить
                                    </button>
                                </div>
                            ` : ''}
                        `;
                        
                        // Добавляем обработчик клика
                        characterItem.addEventListener('click', () => {
                            this.selectCharacter(char.name, displayName, characterItem);
                        });
                        
                        this.characterList.appendChild(characterItem);
                    } catch (error) {
                        console.error(`Error processing character ${char.name}:`, error);
                    }
                });
                
                // Обновляем заголовок для первого персонажа
                if (characters.length > 0) {
                    this.updateChatTitle(characters[0].display_name || characters[0].name);
                    // Загружаем данные первого персонажа
                    this.currentCharacterData = characters[0];
                    this.currentCharacter = characters[0].name;
                }
                
                console.log(`Successfully loaded ${characters.length} characters`);
            }
            
            async selectCharacter(characterName, displayName, clickedElement) {
                // Убираем активный класс со всех элементов
                this.characterList.querySelectorAll('.character-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Добавляем активный класс к выбранному
                clickedElement.classList.add('active');
                
                // Обновляем текущего персонажа
                this.currentCharacter = characterName;
                this.updateChatTitle(displayName);
                
                // Загружаем данные персонажа из БД
                await this.loadCharacterData(characterName);
                
                // Загружаем историю чата для нового персонажа (если есть права)
                if (this.canSaveHistory) {
                    await this.loadChatHistory();
                } else {
                    // Если история недоступна, очищаем чат
                    this.clearChat();
                    this.hideClearHistoryButton(); // Скрываем кнопку если история недоступна
                }
            }
            
            async loadCharacterData(characterName) {
                try {
                    // Получаем данные персонажа из БД
                    const response = await fetch(`/api/v1/characters/`);
                    if (response.ok) {
                        const characters = await response.json();
                        const character = characters.find(char => 
                            char.name.toLowerCase() === characterName.toLowerCase()
                        );
                        
                        if (character) {
                            console.log(`✅ Данные персонажа '${characterName}' загружены из БД:`, character);
                            // Сохраняем данные персонажа для использования в чате
                            this.currentCharacterData = character;
                        } else {
                            console.warn(`⚠️ Персонаж '${characterName}' не найден в БД`);
                        }
                    }
                } catch (error) {
                    console.error('Ошибка загрузки данных персонажа:', error);
                }
            }
            
            updateChatTitle(characterName) {
                this.chatTitle.textContent = `Чат с ${characterName}`;
            }
            
            async openPaidGallery() {
                const character = (this.currentCharacter || 'anna').toLowerCase();
                try {
                    const res = await fetch(`/api/v1/paid-gallery/${character}`);
                    if (!res.ok) throw new Error('Галерея недоступна');
                    const data = await res.json();

                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay';
                    const imagesHtml = data.images && data.images.length
                        ? data.images.map(img => `
                            <div style="width:160px;margin:6px;cursor:pointer">
                                <img src="${img.url}" alt="${img.name}" style="width:160px;height:auto;border-radius:8px;border:1px solid #e0e0e0" onclick="window.open('${img.url}','_blank')">
                                <div style="font-size:12px;color:#666;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${img.name}</div>
                            </div>
                        `).join('')
                        : '<p>Пока нет изображений.</p>';

                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>💎 Галерея: ${character}</h3>
                            <div style="display:flex;flex-wrap:wrap;justify-content:flex-start">${imagesHtml}</div>
                            <div class="modal-buttons" style="margin-top:12px">
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Закрыть</button>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                } catch (e) {
                    this.showError('Не удалось открыть платную галерею');
                }
            }


            async sendMessage() {
                // Проверяем авторизацию
                if (!authToken) {
                    this.showAuthRequiredModal();
                    return;
                }

                const message = this.messageInput.value.trim();
                if (!message) return;

                this.addMessage('user', message);
                this.messageInput.value = '';
                this.setLoading(true);
                this.hideError();

                try {
                    const requestBody = {
                        message: message,
                        character: this.currentCharacter,
                        history: this.messages,
                        session_id: this.sessionId
                    };
                    
                    // Добавляем user_id если пользователь авторизован
                    if (authToken && currentUser) {
                        requestBody.user_id = currentUser.id;
                    }
                    
                    
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Ошибка отправки сообщения');
                    }
                    
                    const data = await response.json();
                    console.log('Получен ответ от API:', data);
                    
                    if (!data || !data.response) {
                        console.error('API вернул пустой ответ:', data);
                        throw new Error('API вернул пустой ответ');
                    }
                    
                    const assistantResponse = data.response;
                    this.addMessage('assistant', assistantResponse);
                    
                    // Обновляем количество монет после отправки сообщения
                    if (authToken && currentUser) {
                        await fetchUserInfo();
                    }
                    
                } catch (error) {
                    this.showError('Ошибка отправки сообщения: ' + error.message);
                } finally {
                    this.setLoading(false);
                }
            }

            async sendMessageWithImage() {
                // Проверяем авторизацию
                if (!authToken) {
                    this.showAuthRequiredModal();
                    return;
                }

                const message = this.messageInput.value.trim();
                if (!message) return;

                this.addMessage('user', message);
                this.messageInput.value = '';
                this.setLoading(true);
                this.hideError();
                
                // Отключаем кнопки во время генерации
                this.sendButton.disabled = true;
                this.generateImageButton.disabled = true;

                try {
                    const requestBody = {
                        message: message,
                        character: this.currentCharacter,
                        history: this.messages,
                        session_id: this.sessionId,
                        generate_image: true,
                        image_prompt: message,
                        image_steps: this.generationSettings?.steps || (await this.getFallbackValue('steps'))
                    };
                    
                    // Добавляем user_id если пользователь авторизован
                    if (authToken && currentUser) {
                        requestBody.user_id = currentUser.id;
                    }
                    
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Ошибка отправки сообщения');
                    }
                    
                    const data = await response.json();
                    console.log('Получен ответ от API:', data);
                    
                    if (!data || !data.response) {
                        console.error('API вернул пустой ответ:', data);
                        throw new Error('API вернул пустой ответ');
                    }
                    
                    const assistantResponse = data.response;
                    // Добавляем текстовый ответ
                    this.addMessage('assistant', assistantResponse);
                    
                    // Если есть изображение, добавляем его
                    if (data.image_generated && data.image_url) {
                        console.log(`🖼️ DEBUG: Добавляем изображение: ${data.image_url}`);
                        this.addImageMessage(data.image_url, data.image_filename);
                    } else {
                        console.log(`⚠️ DEBUG: Изображение не найдено в ответе. image_generated: ${data.image_generated}, image_url: ${data.image_url}`);
                    }
                    
                    // Обновляем количество монет после отправки сообщения с изображением
                    if (authToken && currentUser) {
                        await fetchUserInfo();
                    }
                    
                } catch (error) {
                    this.showError('Ошибка отправки сообщения: ' + error.message);
                } finally {
                    this.setLoading(false);
                    // Включаем кнопки обратно
                    this.sendButton.disabled = false;
                    this.generateImageButton.disabled = false;
                }
            }

            sendQuickMessage(message) {
                this.messageInput.value = message;
                this.sendMessage();
            }
            
            async sendMessageWithImage() {
                // Проверяем авторизацию
                if (!authToken) {
                    this.showAuthRequiredModal();
                    return;
                }
                
                // Если пользователь авторизован, запускаем генерацию изображения
                await this.generatePhoto();
            }
            
            async continueStory() {
                this.messageInput.value = 'continue the story briefly';
                this.sendMessage();
            }
            
            clearChat() {
                const activeCharacter = this.characterList.querySelector('.character-item.active');
                const characterName = activeCharacter ? activeCharacter.querySelector('.character-name').textContent : 'Персонаж';
                
                this.chatMessages.innerHTML = `
                    <div class="message assistant">
                    <div class="message-content">
                            Привет! Я ${characterName}. Как дела? 😊
                        </div>
                    </div>
                `;
                this.messages = [];
                this.sessionId = 'chat_' + Date.now();
                this.hideClearHistoryButton(); // Скрываем кнопку "Очистить историю"
            }
            
            async generatePhoto() {
                // Показываем модальное окно для ввода промпта
                this.showPromptModal();
            }
            
            showPromptModal() {
                // Создаем модальное окно
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>📸 Генерация фото</h3>
                        <p>Введите описание для генерации фото:</p>
                        <textarea id="promptInput" placeholder="Например: beautiful portrait, anime style, detailed, high quality" rows="4"></textarea>
                        <div class="modal-buttons">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Отмена</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Фокусируемся на поле ввода
                setTimeout(() => {
                    const textarea = modal.querySelector('#promptInput');
                    textarea.focus();
                }, 100);
            }
            
            async generatePhotoWithPrompt() {
                // Проверяем авторизацию
                if (!authToken) {
                    // Закрываем модальное окно генерации
                    document.querySelector('.modal-overlay').remove();
                    this.showAuthRequiredModal();
                    return;
                }
                
                const promptInput = document.querySelector('#promptInput');
                const prompt = promptInput.value.trim();
                
                if (!prompt) {
                    alert('Пожалуйста, введите описание для генерации фото');
                    return;
                }
                
                // Закрываем модальное окно
                document.querySelector('.modal-overlay').remove();
                
                try {
                this.setLoading(true);
                    this.hideError();

                    const requestBody = {
                        character: this.currentCharacter,
                        prompt: prompt,
                        negative_prompt: this.generationSettings?.negative_prompt || (await this.getFallbackValue('negative_prompt')),
                        width: this.generationSettings?.width || (await this.getFallbackValue('width')),
                        height: this.generationSettings?.height || (await this.getFallbackValue('height')),
                        steps: this.generationSettings?.steps || (await this.getFallbackValue('steps')),
                        cfg_scale: this.generationSettings?.cfg_scale || (await this.getFallbackValue('cfg_scale')),
                        use_default_prompts: false
                    };
                    
                    // Добавляем user_id если пользователь авторизован
                    if (authToken && currentUser) {
                        requestBody.user_id = currentUser.id;
                    }

                    const response = await fetch('/api/v1/generate-image/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Ошибка генерации изображения');
                    }
                    
                    const data = await response.json();
                    
                    // Добавляем сообщение с изображением
                    this.addMessage('assistant', `Вот твое фото! 📸`, data.image_url);
                    
                } catch (error) {
                    console.error('Ошибка генерации фото:', error);
                    this.showError(`Ошибка генерации фото: ${error.message}`);
                } finally {
                    this.setLoading(false);
                }
            }

            addMessage(role, content, imageUrl = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                let messageContent = `<div class="message-content">${content}</div>`;
                if (imageUrl) {
                    messageContent += `<div class="message-image"><img src="${imageUrl}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin-top: 10px;"></div>`;
                }
                
                messageDiv.innerHTML = messageContent;
                this.chatMessages.appendChild(messageDiv);
                
                // Сохраняем в историю
                this.messages.push({
                    role: role,
                    content: content,
                    imageUrl: imageUrl
                });
                
                // Сохраняем в базу данных (если есть права)
                if (this.canSaveHistory) {
                    this.saveMessageToHistory(role, content, imageUrl);
                    // Показываем кнопку "Очистить историю" если есть сообщения
                    if (this.messages.length > 0) {
                        this.showClearHistoryButton();
                    }
                }
                
                // Прокручиваем вниз
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            addImageMessage(imageUrl, filename) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                
                const messageContent = `
                    <div class="message-content">🎨 Сгенерировано изображение: ${filename}</div>
                    <div class="message-image">
                        <img src="${imageUrl}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin-top: 10px;" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; color: #666; font-style: italic; margin-top: 10px;">
                            ⚠️ Ошибка загрузки изображения. Попробуйте обновить страницу.
                        </div>
                    </div>
                `;
                
                messageDiv.innerHTML = messageContent;
                this.chatMessages.appendChild(messageDiv);
                
                // Сохраняем в историю
                this.messages.push({
                    role: 'assistant',
                    content: `🎨 Сгенерировано изображение: ${filename}`,
                    imageUrl: imageUrl
                });
                
                // Прокручиваем вниз
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            // Функции для работы с историей чата
            async checkHistoryPermissions() {
                if (!authToken || !currentUser) {
                    this.canSaveHistory = false;
                    return false;
                }
                
                try {
                    // Проверяем подписку пользователя
                    const response = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        console.log('Данные пользователя для проверки подписки:', userData);
                        
                        // Проверяем подписку пользователя
                        if (userData.subscription && userData.subscription.subscription_type) {
                            const subscriptionType = userData.subscription.subscription_type.toLowerCase();
                            this.canSaveHistory = subscriptionType !== 'base';
                            console.log(`📚 История чата: ${this.canSaveHistory ? 'доступна' : 'недоступна'} (подписка: ${subscriptionType})`);
                        } else {
                            // Если нет информации о подписке, считаем что Base
                            this.canSaveHistory = false;
                            console.log('📚 История чата: недоступна (нет информации о подписке)');
                        }
                        
                        return this.canSaveHistory;
                    }
                } catch (error) {
                    console.error('Ошибка проверки подписки:', error);
                }
                
                // По умолчанию запрещаем сохранение истории
                this.canSaveHistory = false;
                console.log('📚 История чата: недоступна (ошибка проверки)');
                return false;
            }
            
            async saveMessageToHistory(messageType, content, imageUrl = null, imageFilename = null) {
                if (!this.canSaveHistory || !this.currentCharacter) return;
                
                try {
                    const response = await fetch('/api/v1/chat-history/save-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            character_name: this.currentCharacter,
                            session_id: this.sessionId,
                            message_type: messageType,
                            message_content: content,
                            image_url: imageUrl,
                            image_filename: imageFilename
                        })
                    });
                    
                    if (response.ok) {
                        console.log(`💾 Сообщение сохранено в историю: ${messageType}`);
                    } else {
                        console.warn('Не удалось сохранить сообщение в историю');
                    }
                } catch (error) {
                    console.error('Ошибка сохранения сообщения в историю:', error);
                }
            }
            
            async saveMessageToHistory(messageType, content, imageUrl = null, imageFilename = null) {
                if (!this.canSaveHistory || !this.currentCharacter) {
                    console.log('saveMessageToHistory: пропущено - canSaveHistory:', this.canSaveHistory, 'currentCharacter:', this.currentCharacter);
                    return;
                }
                
                console.log('saveMessageToHistory: начинаем сохранение', {
                    messageType,
                    content: content.substring(0, 50) + '...',
                    character: this.currentCharacter,
                    sessionId: this.sessionId
                });
                
                try {
                    const response = await fetch('/api/v1/chat-history/save-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            character_name: this.currentCharacter,
                            message_type: messageType,
                            message_content: content,
                            session_id: this.sessionId,
                            image_url: imageUrl,
                            image_filename: imageFilename
                        })
                    });
                    
                    console.log('saveMessageToHistory: ответ сервера', response.status, response.statusText);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('💾 Сообщение сохранено в историю:', data);
                    } else {
                        const errorText = await response.text();
                        console.warn('Не удалось сохранить сообщение в историю:', response.status, errorText);
                    }
                } catch (error) {
                    console.error('Ошибка сохранения сообщения в историю:', error);
                }
            }
            
            async loadChatHistory() {
                if (!this.canSaveHistory || !this.currentCharacter) return;
                
                // Сначала очищаем чат
                this.clearChat();
                
                try {
                    const response = await fetch('/api/v1/chat-history/get-history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            character_name: this.currentCharacter
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.history && data.history.length > 0) {
                            console.log(`📖 Загружена история чата: ${data.history.length} сообщений`);
                            
                            // Преобразуем данные из API в формат для отображения
                            this.messages = data.history.map(msg => ({
                                role: msg.message_type,
                                content: msg.message_content,
                                imageUrl: msg.image_url,
                                imageFilename: msg.image_filename
                            }));
                            
                            this.updateChatDisplay();
                            
                            // Показываем кнопку "Очистить историю"
                            this.showClearHistoryButton();
                        } else {
                            console.log(`📭 История для персонажа ${this.currentCharacter} пуста`);
                            // Скрываем кнопку "Очистить историю"
                            this.hideClearHistoryButton();
                        }
                    }
                } catch (error) {
                    console.error('Ошибка загрузки истории чата:', error);
                }
            }
            
            showClearHistoryButton() {
                const clearHistoryBtn = document.getElementById('clearHistoryBtn');
                if (clearHistoryBtn) {
                    clearHistoryBtn.style.display = 'inline-block';
                }
            }
            
            hideClearHistoryButton() {
                const clearHistoryBtn = document.getElementById('clearHistoryBtn');
                if (clearHistoryBtn) {
                    clearHistoryBtn.style.display = 'none';
                }
            }
            
            async clearChatHistory() {
                if (!this.canSaveHistory || !this.currentCharacter) {
                    showError('История чата недоступна');
                    return;
                }
                
                // Показываем подтверждение
                const confirmed = confirm(`Вы уверены, что хотите очистить всю историю чата с персонажем "${this.currentCharacter}"?\n\nЭто действие нельзя отменить!`);
                if (!confirmed) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/v1/chat-history/clear-history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            character_name: this.currentCharacter
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log('🗑️ История чата очищена');
                            this.messages = [];
                            this.updateChatDisplay();
                            this.hideClearHistoryButton(); // Скрываем кнопку после очистки
                            showSuccess(`История чата с персонажем "${this.currentCharacter}" очищена!`);
                        } else {
                            showError('Не удалось очистить историю чата');
                        }
                    } else {
                        showError('Ошибка при очистке истории чата');
                    }
                } catch (error) {
                    console.error('Ошибка очистки истории чата:', error);
                    showError('Ошибка при очистке истории чата');
                }
            }
            
            updateChatDisplay() {
                // Очищаем текущий чат
                this.chatMessages.innerHTML = '';
                
                // Отображаем все сообщения из истории
                this.messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.type || message.role}`;
                    
                    let messageContent = `<div class="message-content">${message.content}</div>`;
                    
                    // Добавляем изображение, если есть
                    if (message.image_url || message.imageUrl) {
                        const imageUrl = message.image_url || message.imageUrl;
                        messageContent += `<div class="message-image"><img src="${imageUrl}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin-top: 10px;"></div>`;
                    }
                    
                    messageDiv.innerHTML = messageContent;
                    this.chatMessages.appendChild(messageDiv);
                });
                
                // Управляем видимостью кнопки "Очистить историю"
                if (this.messages.length > 0 && this.canSaveHistory) {
                    this.showClearHistoryButton();
                } else {
                    this.hideClearHistoryButton();
                }
                
                // Прокручиваем вниз
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            setLoading(loading) {
                this.loading.style.display = loading ? 'block' : 'none';
                this.sendButton.disabled = loading;
                this.messageInput.disabled = loading;
            }

            showError(message) {
                this.error.textContent = message;
                this.error.style.display = 'block';
            }
                
            hideError() {
                this.error.style.display = 'none';
            }
            
            showAuthRequiredModal() {
                const modal = document.getElementById('authRequiredModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }
        }

        // Инициализация чата
        let chatApp;
        document.addEventListener('DOMContentLoaded', async () => {
            chatApp = new ChatApp();
            window.chatApp = chatApp; // Делаем доступным глобально
            
            // Проверяем авторизацию после инициализации chatApp
            await checkAuth();
            handleOAuthCallback(); // Обрабатываем OAuth callback
        });

        // Функции редактирования персонажей
        async function editCharacter(characterName) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('❌ Необходимо войти в систему для редактирования персонажей');
                return;
            }

            try {
                // Получаем данные персонажа
                const response = await fetch(`/api/v1/characters/${characterName}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Персонаж не найден');
                }

                const character = await response.json();
                showEditModal(character);
            } catch (error) {
                console.error('Ошибка загрузки персонажа:', error);
                alert('❌ Ошибка при загрузке персонажа: ' + error.message);
            }
        }

        async function deleteCharacter(characterName) {
            if (!confirm(`Вы уверены, что хотите удалить персонажа "${characterName}"?`)) {
                return;
            }

            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('❌ Необходимо войти в систему для удаления персонажей');
                return;
            }

            try {
                const response = await fetch(`/api/v1/characters/${characterName}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('✅ Персонаж успешно удален!');
                    // Перезагружаем список персонажей
                    chatApp.loadInfo();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка удаления персонажа');
                }
            } catch (error) {
                console.error('Ошибка удаления персонажа:', error);
                alert('❌ Ошибка при удалении персонажа: ' + error.message);
            }
        }

        function showEditModal(character) {
            // Удаляем существующее модальное окно, если есть
            const existingModal = document.querySelector('.edit-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Создаем модальное окно редактирования
            const modal = document.createElement('div');
            modal.className = 'edit-modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>✏️ Редактировать персонажа: ${character.name}</h3>
                        <button class="close-btn" onclick="this.closest('.edit-modal').remove()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="editName">Имя персонажа:</label>
                        <input type="text" id="editName" placeholder="Введите имя персонажа..." value="${character.name || ''}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editPrompt">Промпт персонажа:</label>
                        <textarea id="editPrompt" placeholder="Введите промпт персонажа...">${character.prompt || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAppearance">Внешность:</label>
                        <textarea id="editAppearance" placeholder="Опишите внешность персонажа...">${character.character_appearance || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editLocation">Локация:</label>
                        <textarea id="editLocation" placeholder="Опишите локацию персонажа...">${character.location || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="this.closest('.edit-modal').remove()">Отмена</button>
                        <button class="btn btn-primary" onclick="saveCharacterEdit('${character.name}')">Сохранить</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function saveCharacterEdit(characterName) {
            const token = localStorage.getItem('authToken');
            const characterData = {};
            
            // Добавляем только те поля, которые не пустые
            const name = document.getElementById('editName').value.trim();
            const prompt = document.getElementById('editPrompt').value.trim();
            const appearance = document.getElementById('editAppearance').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            
            if (name) characterData.name = name;
            if (prompt) characterData.prompt = prompt;
            if (appearance) characterData.character_appearance = appearance;
            if (location) characterData.location = location;
            
            // Проверяем, что хотя бы одно поле было заполнено
            if (Object.keys(characterData).length === 0) {
                alert('❌ Необходимо заполнить хотя бы одно поле');
                return;
            }

            try {
                const response = await fetch(`/api/v1/characters/${characterName}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(characterData)
                });

                if (response.ok) {
                    alert('✅ Персонаж успешно обновлен!');
                    document.querySelector('.edit-modal').remove();
                    // Перезагружаем список персонажей
                    chatApp.loadInfo();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка обновления персонажа');
                }
            } catch (error) {
                console.error('Ошибка сохранения персонажа:', error);
                alert('❌ Ошибка при сохранении персонажа: ' + error.message);
            }
        }

        // Система авторизации
        let authToken = localStorage.getItem('authToken');
        let refreshToken = localStorage.getItem('refreshToken');
        let currentUser = null;
        
        // Сразу скрываем кнопки авторизации если есть токен
        if (authToken) {
            // Добавляем CSS для принудительного скрытия кнопок авторизации
            const style = document.createElement('style');
            style.textContent = '#authButtons { display: none !important; } #userButtons { display: block !important; }';
            document.head.appendChild(style);
        }

        // Проверка, является ли пользователь админом
        function isAdmin() {
            const result = currentUser && currentUser.is_admin === true;
            console.log('DEBUG: isAdmin() called:', {
                currentUser: currentUser,
                is_admin: currentUser?.is_admin,
                result: result
            });
            return result;
        }

        // Простые функции уведомлений
        function showSuccess(message) {
            alert('✅ ' + message);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        // Проверка авторизации при загрузке
        async function checkAuth() {
            console.log('checkAuth called, authToken:', authToken ? 'present' : 'missing');
            
            // Всегда загружаем информацию о персонажах (для всех пользователей)
            if (window.chatApp && window.chatApp.loadInfo) {
                await window.chatApp.loadInfo();
            }
            
            // Если нет токена, показываем кнопки авторизации
            if (!authToken) {
                showAuthButtons();
                return false;
            }
            
            // Если есть токен, проверяем его валидность
                try {
                    const response = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                if (response.ok) {
                    currentUser = await response.json();
                    console.log('User info received:', currentUser);
                    console.log('DEBUG: currentUser.is_admin =', currentUser.is_admin);
                    
                    // Обновляем отображение пользователя
                    document.getElementById('usernameDisplay').textContent = currentUser.email;
                    document.getElementById('coinsDisplay').textContent = currentUser.coins || 0;
                    
                    // Перезагружаем список персонажей с актуальной информацией о пользователе
                    if (window.chatApp && window.chatApp.loadInfo) {
                        await window.chatApp.loadInfo();
                    }
                    
                    // Инициализируем систему редактирования персонажей
                    if (window.characterEditor) {
                        console.log('Initializing CharacterEditor with user:', currentUser);
                        window.characterEditor.init(currentUser, authToken);
                    } else {
                        console.error('CharacterEditor not available!');
                    }
                    
                    showUserButtons();
                    console.log('checkAuth: showUserButtons called, currentUser:', currentUser);
                    return true;
                    } else {
                        // Попробуем обновить токен
                        if (refreshToken) {
                            const refreshed = await refreshAccessToken();
                            if (refreshed) {
                                // Перезагружаем список персонажей с актуальной информацией о пользователе
                                if (window.chatApp && window.chatApp.loadInfo) {
                                    await window.chatApp.loadInfo();
                                }
                                return true;
                            }
                        }
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('refreshToken');
                        authToken = null;
                        refreshToken = null;
                    }
                } catch (error) {
                    console.error('Ошибка проверки авторизации:', error);
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('refreshToken');
                    authToken = null;
                    refreshToken = null;
                }
            
            // Если дошли до сюда, значит токен недействителен
            showAuthButtons();
            return false;
        }

        // Обновление access token
        async function refreshAccessToken() {
            if (!refreshToken) return false;
            
            try {
                const response = await fetch('/auth/refresh/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    // Получаем информацию о пользователе
                    const userResponse = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    currentUser = await userResponse.json();
                    showUserButtons();
                    console.log('refreshAccessToken: showUserButtons called, currentUser:', currentUser);
                    return true;
                }
            } catch (error) {
                console.error('Ошибка обновления токена:', error);
            }
            return false;
        }

        // Показать кнопки авторизации
        function showAuthButtons() {
            console.log('showAuthButtons called');
            document.getElementById('authButtons').style.display = 'block';
            document.getElementById('userButtons').style.display = 'none';
        }

        // Показать кнопки пользователя
        function showUserButtons() {
            console.log('showUserButtons called, currentUser:', currentUser);
            console.log('showUserButtons called, authToken:', authToken ? 'present' : 'missing');
            
            const authButtons = document.getElementById('authButtons');
            const userButtons = document.getElementById('userButtons');
            
            console.log('authButtons element:', authButtons);
            console.log('userButtons element:', userButtons);
            
            if (authButtons) {
                authButtons.style.display = 'none';
            }
            if (userButtons) {
                userButtons.style.display = 'block';
                // Принудительно показываем кнопки пользователя
                userButtons.style.setProperty('display', 'block', 'important');
            }
            
            const usernameDisplay = document.getElementById('usernameDisplay');
            const coinsDisplay = document.getElementById('coinsDisplay');
            
            if (usernameDisplay) {
                usernameDisplay.textContent = currentUser ? currentUser.email : 'Пользователь';
            }
            if (coinsDisplay) {
                coinsDisplay.textContent = currentUser ? currentUser.coins || 0 : 0;
            }
            
            console.log('User buttons shown');
        }

        // Модальные окна
        function showLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            }
        }

        function hideLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'none';
            }
        }

        function showRegisterModal() {
            const registerModal = document.getElementById('registerModal');
            if (registerModal) {
                registerModal.style.display = 'flex';
            }
        }

        function hideRegisterModal() {
            const registerModal = document.getElementById('registerModal');
            if (registerModal) {
                registerModal.style.display = 'none';
            }
        }

        function showVerificationModal(email, password) {
            console.log('showVerificationModal called with:', email, password);
            const modal = document.getElementById('verificationModal');
            if (!modal) {
                console.error('verificationModal element not found!');
                return;
            }
            modal.style.display = 'flex';
            // Сохраняем email и пароль для верификации
            modal.dataset.email = email;
            modal.dataset.password = password;
            // Очищаем поле кода
            document.getElementById('verificationCode').value = '';
            console.log('Verification modal should be visible now');
        }

        function hideVerificationModal() {
            document.getElementById('verificationModal').style.display = 'none';
        }

        function showProfileModal() {
            if (currentUser) {
                document.getElementById('profileEmail').textContent = currentUser.email || 'Неизвестно';
                document.getElementById('profileId').textContent = currentUser.id || 'Неизвестно';
                document.getElementById('profileStatus').textContent = currentUser.is_active ? 'Активен' : 'Неактивен';
                document.getElementById('profileCoins').textContent = currentUser.coins || 0;
                document.getElementById('profileCreatedAt').textContent = currentUser.created_at ?
                    new Date(currentUser.created_at).toLocaleDateString() : 'Неизвестно';
                document.getElementById('profileModal').style.display = 'flex';
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // Модальные окна магазина
        function showShopModal() {
            // Загружаем статистику подписки если пользователь авторизован
            if (authToken) {
                loadSubscriptionStats();
            }
            
            document.getElementById('shopModal').style.display = 'flex';
        }

        function hideShopModal() {
            document.getElementById('shopModal').style.display = 'none';
        }

        async function loadSubscriptionStats() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/v1/subscription/stats/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('usedCredits').textContent = stats.used_credits || 0;
                    document.getElementById('totalCredits').textContent = stats.total_credits || 100;
                    document.getElementById('usedPhotos').textContent = stats.used_photos || 0;
                    document.getElementById('totalPhotos').textContent = stats.total_photos || 10;
                    document.getElementById('daysLeft').textContent = stats.days_left || 30;
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики подписки:', error);
            }
        }

        async function activateSubscription(subscriptionType) {
            if (!authToken) {
                showError('Необходимо войти в систему');
                return;
            }

            try {
                const response = await fetch('/api/v1/subscription/activate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        subscription_type: subscriptionType
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(result.message);
                    
                    // Обновляем информацию о пользователе
                    await fetchUserInfo();
                    
                    // Обновляем статистику
                    await loadSubscriptionStats();
                } else {
                    const error = await response.json();
                    showError('Ошибка активации подписки: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка активации подписки:', error);
                showError('Ошибка соединения');
            }
        }

        // Для обратной совместимости
        async function activateBaseSubscription() {
            await activateSubscription('base');
        }

        // Модальное окно создания персонажа
        function showCreateCharacterModal() {
            if (!authToken) {
                showError('Необходимо войти в систему для создания персонажа');
                return;
            }
            
            // Обновляем информацию о монетах
            if (currentUser) {
                document.getElementById('userCoinsInfo').textContent = `У вас: ${currentUser.coins || 0} монет`;
            }
            
            document.getElementById('createCharacterModal').style.display = 'flex';
        }

        function hideCreateCharacterModal() {
            document.getElementById('createCharacterModal').style.display = 'none';
            // Очищаем форму
            document.getElementById('createCharacterForm').reset();
        }

        // Модальное окно требования авторизации
        function showAuthRequiredModal() {
            const modal = document.getElementById('authRequiredModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function hideAuthRequiredModal() {
            const modal = document.getElementById('authRequiredModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Вход
        async function login(email, password) {
            try {
                const response = await fetch('/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    // Получаем информацию о пользователе
                    const userResponse = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    currentUser = await userResponse.json();
                    
                    showUserButtons();
                    hideLoginModal();
                    showSuccess('Успешный вход!');
                    return true;
                } else {
                    const error = await response.json();
                    showError('Ошибка входа: ' + (error.detail || 'Неизвестная ошибка'));
                    return false;
                }
            } catch (error) {
                console.error('Ошибка входа:', error);
                showError('Ошибка соединения');
                return false;
            }
        }

        // Верификация email
        async function verifyEmail(email, code) {
            try {
                const password = document.getElementById('verificationModal').dataset.password;
                const response = await fetch('/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        verification_code: code
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);

                    // Получаем информацию о пользователе
                    const userResponse = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    currentUser = await userResponse.json();

                    showUserButtons();
                    hideVerificationModal();
                    showSuccess('Email подтвержден! Вход выполнен успешно!');
                    return true;
                } else {
                    const error = await response.json();
                    showError('Ошибка: ' + (error.detail || 'Неверный код подтверждения'));
                    return false;
                }
            } catch (error) {
                console.error('Ошибка верификации:', error);
                showError('Ошибка соединения');
                return false;
            }
        }

        // Регистрация
        async function register(email, password) {
            console.log('register function called with:', email, password);
            try {
                const response = await fetch('/auth/register/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                if (response.ok) {
                    console.log('Registration successful, showing verification modal for:', email);
                    showSuccess('Регистрация успешна! Проверьте email для получения кода верификации.');
                    hideRegisterModal();
                    showVerificationModal(email, password);
                    return true;
                } else {
                    const error = await response.json();
                    showError('Ошибка регистрации: ' + (error.detail || 'Неизвестная ошибка'));
                    return false;
                }
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                showError('Ошибка соединения');
                return false;
            }
        }

        // Создание персонажа
        async function createCharacter(characterData) {
            if (!authToken) {
                showError('Необходимо войти в систему');
                return;
            }

            // Обновляем информацию о пользователе перед проверкой
            await fetchUserInfo();
            
            // Проверяем, что у пользователя достаточно монет
            if (!currentUser) {
                showError('Ошибка загрузки информации о пользователе');
                return;
            }
            
            console.log('DEBUG: Текущий пользователь:', currentUser);
            console.log('DEBUG: Монеты пользователя:', currentUser.coins);
            
            if (currentUser.coins < 10) {
                showError(`Недостаточно монет! У вас: ${currentUser.coins}, необходимо: 10 монет для создания персонажа.`);
                return;
            }

            try {
                const response = await fetch('/api/v1/characters/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(characterData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`Персонаж "${characterData.name}" создан успешно! Потрачено 10 монет.`);
                    
                    // Обновляем информацию о пользователе
                    await fetchUserInfo();
                    
                    // Закрываем модальное окно
                    hideCreateCharacterModal();
                    
                    // Обновляем список персонажей
                    if (typeof chatApp !== 'undefined' && chatApp.loadInfo) {
                        chatApp.loadInfo();
                    }
                } else {
                    const error = await response.json();
                    showError('Ошибка создания персонажа: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка создания персонажа:', error);
                showError('Ошибка соединения');
            }
        }

        // Вход через Google
        function loginWithGoogle() {
            window.location.href = '/auth/google/';
        }

        // Обработка OAuth callback
        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const refreshTokenValue = urlParams.get('refresh_token');

            console.log('OAuth callback - accessToken:', accessToken ? 'present' : 'missing');
            console.log('OAuth callback - refreshToken:', refreshTokenValue ? 'present' : 'missing');

            if (accessToken && refreshTokenValue) {
                // Сохраняем токены
                localStorage.setItem('authToken', accessToken);
                localStorage.setItem('refreshToken', refreshTokenValue);        
                authToken = accessToken;
                refreshToken = refreshTokenValue;

                console.log('Tokens saved, calling showUserButtons()');

                // Очищаем URL
                window.history.replaceState({}, document.title, window.location.pathname);

                // Обновляем UI
                showUserButtons();
                showSuccess('Вход через Google выполнен успешно!');

                // Получаем информацию о пользователе
                fetchUserInfo();
            } else {
                console.log('OAuth callback - missing tokens, showing auth buttons');
                showAuthButtons();
            }
        }

        // Получение информации о пользователе
        async function fetchUserInfo() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/auth/me/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('usernameDisplay').textContent = currentUser.email;
                    document.getElementById('coinsDisplay').textContent = currentUser.coins || 0;
                }
            } catch (error) {
                console.error('Ошибка получения информации о пользователе:', error);
            }
        }

        // Выход
        async function logout() {
            try {
                if (refreshToken) {
                    await fetch('/auth/logout/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            refresh_token: refreshToken
                        })
                    });
                }
            } catch (error) {
                console.error('Ошибка при выходе:', error);
            }
            
            authToken = null;
            refreshToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            showAuthButtons();
            hideProfileModal();
            showSuccess('Вы вышли из системы');
        }

        // Обработчики форм
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;     
            const password = document.getElementById('loginPassword').value;                                                                               
            await login(email, password);        
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Register form submitted');
            const email = document.getElementById('registerEmail').value;  
            const password = document.getElementById('registerPassword').value;
            console.log('Email:', email, 'Password length:', password.length);
            await register(email, password);
        });

        document.getElementById('verificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('verificationModal').dataset.email;
            const code = document.getElementById('verificationCode').value;
            await verifyEmail(email, code);
        });

        document.getElementById('createCharacterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const characterData = {
                name: formData.get('name'),
                personality: formData.get('personality'),
                situation: formData.get('situation'),
                instructions: formData.get('instructions'),
                style: formData.get('style') || '',
                appearance: formData.get('appearance') || '',
                location: formData.get('location') || ''
            };
            await createCharacter(characterData);
        });

        // Закрытие модальных окон по клику вне их
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                hideLoginModal();
                hideRegisterModal();
                hideVerificationModal();
                hideProfileModal();
                hideShopModal();
                hideCreateCharacterModal();
            }
        });
    </script>
</body>
</html> 