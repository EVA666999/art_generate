<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            background: white;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .generate-image-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-left: 10px;
        }

        .generate-image-button:hover {
            transform: translateY(-2px);
        }

        .generate-image-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .info-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .info-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-section p {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .character-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .character-item {
            padding: 12px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .character-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
        }

        .character-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .character-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .character-description {
            font-size: 12px;
            opacity: 0.8;
        }


        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: auto;
        }

        .quick-action-btn {
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .quick-action-btn:hover {
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .modal-content p {
            margin-bottom: 15px;
            color: #666;
        }
        
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 20px;
            font-family: inherit;
        }

        .modal-content textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: 1px solid #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }

        .btn-google {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .btn-google:hover {
            background: #3367d6;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .character-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .btn-edit {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-edit:hover {
            background: #218838;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .character-item {
            position: relative;
        }

        .character-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .edit-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="info-section">
                <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</h3>
                <div id="characterList" class="character-list">
                    <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <div class="info-section">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <p id="modelInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>

            <div class="quick-actions">
                <button class="quick-action-btn" onclick="chatApp.sendQuickMessage('–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?')">–ü—Ä–∏–≤–µ—Ç!</button>
                <button class="quick-action-btn" onclick="chatApp.sendQuickMessage('–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ')">–û —Å–µ–±–µ</button>
                <button class="quick-action-btn" onclick="chatApp.continueStory()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
                <button class="quick-action-btn" onclick="chatApp.openPaidGallery()">üíé –ü–ª–∞—Ç–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è</button>
                <button class="quick-action-btn" onclick="showShopModal()">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
                <button class="quick-action-btn" onclick="showCreateCharacterModal()">üë§ –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (10üí∞)</button>
                <button class="quick-action-btn" onclick="chatApp.clearChat()">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div>
                        <h1 id="chatTitle">–ß–∞—Ç —Å Anna</h1>
                        <p>–ü—Ä–æ—Å—Ç–æ–π —á–∞—Ç –±–µ–∑ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ - –ø—Ä—è–º—ã–µ –æ—Ç–≤–µ—Ç—ã –æ—Ç –º–æ–¥–µ–ª–∏</p>
                    </div>
                    <div id="authButtons" style="display: none;">
                        <button id="loginBtn" class="btn btn-primary" onclick="showLoginModal()" style="margin-right: 8px;">
                            –í–æ–π—Ç–∏
                        </button>
                        <button id="registerBtn" class="btn btn-secondary" onclick="showRegisterModal()">
                            –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        </button>
                    </div>
                    <div id="userButtons" style="display: none;">
                        <button id="profileBtn" class="btn btn-primary" onclick="showProfileModal()" style="margin-right: 8px;">
                            üë§ <span id="usernameDisplay"></span> | üí∞ <span id="coinsDisplay">0</span>
                        </button>
                        <button id="clearHistoryBtn" class="btn btn-danger" onclick="chatApp.clearChatHistory()" style="margin-right: 8px;">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                        </button>
                        <button id="logoutBtn" class="btn btn-secondary" onclick="logout()">
                            –í—ã–π—Ç–∏
                        </button>
                    </div>
                </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-content">
                        –ü—Ä–∏–≤–µ—Ç! –Ø Anna. –ö–∞–∫ –¥–µ–ª–∞? üòä
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
                –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç...
        </div>

            <div class="error" id="error"></div>

        <div class="chat-input">
                <input type="text" id="messageInput" class="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="sendButton" class="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button id="generateImageButton" class="generate-image-button">üé® –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="loginModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="loginPassword" name="password" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                    <button type="button" class="btn btn-secondary" onclick="hideLoginModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <div style="margin: 10px 0; color: #666;">–∏–ª–∏</div>
                    <button type="button" class="btn btn-google" onclick="loginWithGoogle()">
                        <img src="https://developers.google.com/identity/images/g-logo.png" 
                             style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;">
                        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –∑–∞–≥–ª–∞–≤–Ω—ã–µ, —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã):</label>
                    <input type="password" id="registerPassword" name="password" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <button type="button" class="btn btn-secondary" onclick="hideRegisterModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <div id="verificationModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h3>
            <p>–ù–∞ –≤–∞—à email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ:</p>
            <form id="verificationForm">
                <div class="form-group">
                    <label for="verificationCode">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                    <input type="text" id="verificationCode" name="code" required maxlength="6" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="hideVerificationModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h3>
            <div id="profileInfo">
                <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                <p><strong>ID:</strong> <span id="profileId"></span></p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="profileStatus"></span></p>
                <p><strong>üí∞ –ú–æ–Ω–µ—Ç—ã:</strong> <span id="profileCoins"></span></p>
                <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> <span id="profileCreatedAt"></span></p>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="hideProfileModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞–≥–∞–∑–∏–Ω–∞ -->
    <div id="shopModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <h3>üõí –ú–∞–≥–∞–∑–∏–Ω –ø–æ–¥–ø–∏—Å–æ–∫</h3>
            
            <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                <h4 style="margin: 0 0 10px 0; color: #28a745;">üí° –¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤</h4>
                <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                    ‚Ä¢ <strong>1 —Å–æ–æ–±—â–µ–Ω–∏–µ</strong> = 2 –∫—Ä–µ–¥–∏—Ç–∞<br>
                    ‚Ä¢ <strong>1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ</strong> = 30 –∫—Ä–µ–¥–∏—Ç–æ–≤<br>
                    ‚Ä¢ <strong>–°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</strong> = 10 –∫—Ä–µ–¥–∏—Ç–æ–≤
                </p>
            </div>

            <div class="subscription-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                    –ë–ï–°–ü–õ–ê–¢–ù–û
                </div>
                <h4 style="margin: 0 0 15px 0; font-size: 24px;">Base</h4>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ 100 –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ –º–µ—Å—è—Ü</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ 10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π —Ñ–æ—Ç–æ –≤ –º–µ—Å—è—Ü</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ –ú–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">‚ùå –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 14px; opacity: 0.9;">–ö—Ä–µ–¥–∏—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
                </div>
                <button class="btn btn-primary" onclick="activateSubscription('base')" style="background: white; color: #667eea; font-weight: bold; padding: 12px 25px;">
                    –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É Base
                </button>
            </div>

            <div class="subscription-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                    –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
                </div>
                <h4 style="margin: 0 0 15px 0; font-size: 24px;">Standard</h4>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ 2000 –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ –º–µ—Å—è—Ü</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ –ú–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 14px; opacity: 0.9;">–ö—Ä–µ–¥–∏—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
                </div>
                <button class="btn btn-primary" onclick="activateSubscription('standard')" style="background: white; color: #28a745; font-weight: bold; padding: 12px 25px;">
                    –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É Standard
                </button>
            </div>

            <div class="subscription-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                    –ü–†–ï–ú–ò–£–ú
                </div>
                <h4 style="margin: 0 0 15px 0; font-size: 24px;">Premium</h4>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ 6000 –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ –º–µ—Å—è—Ü</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ –ú–∞–∫—Å–∏–º—É–º 300 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 14px; opacity: 0.9;">–ö—Ä–µ–¥–∏—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
                </div>
                <button class="btn btn-primary" onclick="activateSubscription('premium')" style="background: white; color: #ff6b6b; font-weight: bold; padding: 12px 25px;">
                    –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É Premium
                </button>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h4>
                <div id="subscriptionStats" style="font-size: 14px;">
                    <div>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ: <span id="usedCredits">0</span> / <span id="totalCredits">100</span></div>
                    <div>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π —Ñ–æ—Ç–æ: <span id="usedPhotos">0</span> / <span id="totalPhotos">10</span></div>
                    <div>–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: <span id="daysLeft">30</span></div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideShopModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
    <div id="createCharacterModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3>üë§ –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                <h4 style="margin: 0 0 10px 0; color: #007bff;">üí° Hint!</h4>
                <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                    For quality character creation, follow this format:<br>
                    <strong>Character Name</strong> - enter character name<br>
                    1. <strong>Personality and Character</strong> - describe character personality<br>
                    2. <strong>Role-playing Situation</strong> - what situation the character is in<br>
                    3. <strong>Instructions</strong> - how the character should behave<br>
                    4. <strong>Response Style</strong> (optional) - speech features<br>
                    5. <strong>Appearance</strong> (for photos) - character appearance description<br>
                    6. <strong>Location</strong> (for photos) - where the character is located
                </p>
            </div>
            
            <form id="createCharacterForm">
                <div class="form-group">
                    <label for="characterName">Character Name:</label>
                    <input type="text" id="characterName" name="name" required placeholder="For example: Anna">
                </div>
                
                <div class="form-group">
                    <label for="characterPersonality">1. Personality and Character:</label>
                    <textarea id="characterPersonality" name="personality" required 
                              placeholder="Describe the character's personality, appearance, main character traits..."
                              rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="characterSituation">2. Role-playing Situation:</label>
                    <textarea id="characterSituation" name="situation" required 
                              placeholder="What situation is the character in? What's happening in their world?"
                              rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="characterInstructions">3. Instructions:</label>
                    <textarea id="characterInstructions" name="instructions" required 
                              placeholder="How should the character behave? What rules to follow?"
                              rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="characterStyle">4. Response Style (optional):</label>
                    <textarea id="characterStyle" name="style" 
                              placeholder="Speech features, communication style, favorite phrases..."
                              rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="characterAppearance">5. Character Appearance (for photo generation):</label>
                    <textarea id="characterAppearance" name="appearance" 
                              placeholder="Describe the character's appearance: hair color, eyes, clothing, features..."
                              rows="2"></textarea>
                    <small style="color: #666; font-size: 12px;">üí° This field directly affects image generation!</small>
                </div>
                
                <div class="form-group">
                    <label for="characterLocation">6. Location (for photo generation):</label>
                    <textarea id="characterLocation" name="location" 
                              placeholder="Describe the place where the character is: room, street, nature..."
                              rows="2"></textarea>
                    <small style="color: #666; font-size: 12px;">üí° This field directly affects image generation!</small>
                </div>
                
                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                    <strong>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> 10 –º–æ–Ω–µ—Ç
                    <span id="userCoinsInfo" style="float: right;"></span>
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (10üí∞)</button>
                    <button type="button" class="btn btn-secondary" onclick="hideCreateCharacterModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="authRequiredModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">üí° –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</h4>
                <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                    –ß—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∞–º –Ω—É–∂–Ω–æ:
                </p>
                <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                    <li>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ</li>
                    <li>–ò–ª–∏ –≤–æ–π—Ç–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="hideAuthRequiredModal(); showRegisterModal();">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button class="btn btn-secondary" onclick="hideAuthRequiredModal(); showLoginModal();">–í–æ–π—Ç–∏</button>
                <button class="btn btn-outline" onclick="hideAuthRequiredModal();">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.generateImageButton = document.getElementById('generateImageButton');
                this.loading = document.getElementById('loading');
                this.error = document.getElementById('error');
                this.characterList = document.getElementById('characterList');
                this.modelInfo = document.getElementById('modelInfo');
                this.chatTitle = document.getElementById('chatTitle');
                
                this.messages = [];
                this.sessionId = 'chat_' + Date.now();
                this.currentCharacter = 'anna';
                this.currentCharacterData = null; // –î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –ë–î
                
                // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
                this.canSaveHistory = false;
                this.historyEnabled = false;
                this.generationSettings = null; // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                this.fallbackSettings = {}; // –ö—ç—à –¥–ª—è fallback –∑–Ω–∞—á–µ–Ω–∏–π
                
                this.setupEventListeners();
                // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º loadInfo() —Å—Ä–∞–∑—É - —ç—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ –≤ checkAuth()
            }
            
            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.generateImageButton.addEventListener('click', () => this.sendMessageWithImage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }
            
            async loadInfo() {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞—Ö
                    const charResponse = await fetch('/api/v1/characters/');
                    if (charResponse.ok) {
                        const data = await charResponse.json();
                        console.log('–ü–æ–ª—É—á–µ–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∏:', data);
                        // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –Ω–∞–ø—Ä—è–º—É—é, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º characters
                        this.updateCharacterList(data);
                    } else {
                        console.error('Failed to fetch characters:', charResponse.status, charResponse.statusText);
                        this.characterList.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (HTTP ' + charResponse.status + ')</p>';
                        
                        // –ü–æ–ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
                        try {
                            const altResponse = await fetch('/api/characters/');
                            if (altResponse.ok) {
                                const altData = await altResponse.json();
                                console.log('–ü–æ–ª—É—á–µ–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –∏–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:', altData);
                                this.updateCharacterList(altData);
                            }
                        } catch (altError) {
                            console.error('Alternative endpoint also failed:', altError);
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:', error);
                    this.characterList.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</p>';
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
                if (authToken && currentUser) {
                    await this.checkHistoryPermissions();
                }

                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª—è—Ö
                    const modelResponse = await fetch('/api/v1/models/');
                    if (modelResponse.ok) {
                        const models = await modelResponse.json();
                        this.modelInfo.textContent = `${models.length} –º–æ–¥–µ–ª—å(–µ–π) –¥–æ—Å—Ç—É–ø–Ω–æ`;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π:', error);
                    this.modelInfo.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π';
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                await this.loadGenerationSettings();
            }
            
            async loadGenerationSettings() {
                try {
                    const response = await fetch('/api/v1/generation-settings/');
                    if (response.ok) {
                        this.generationSettings = await response.json();
                        console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', this.generationSettings);
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
                        // –ü–æ–ª—É—á–∞–µ–º fallback –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ API
                        await this.loadFallbackSettings();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
                    // –ü–æ–ª—É—á–∞–µ–º fallback –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ API
                    await this.loadFallbackSettings();
                }
            }

            async loadFallbackSettings() {
                try {
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å fallback –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ API
                    const response = await fetch('/api/v1/fallback-settings/');
                    if (response.ok) {
                        this.generationSettings = await response.json();
                        console.log('Fallback –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ API:', this.generationSettings);
                    } else {
                        throw new Error('Fallback API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ fallback –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                    // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑–µ—Ä–≤ - –ø–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ API
                    try {
                        const response = await fetch('/api/v1/fallback-settings/');
                        if (response.ok) {
                            this.generationSettings = await response.json();
                        } else {
                            throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                        }
                    } catch (error) {
                        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                        // –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                        this.generationSettings = {
                            steps: null,
                            width: null,
                            height: null,
                            cfg_scale: null,
                            sampler_name: null,
                            negative_prompt: null
                        };
                    }
                }
            }

            async getFallbackValue(key) {
                // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ API, –Ω–∏–∫–∞–∫–æ–≥–æ —Ö–∞—Ä–¥–∫–æ–¥–∞!
                if (Object.keys(this.fallbackSettings).length === 0) {
                    try {
                        const response = await fetch('/api/v1/fallback-settings/');
                        if (response.ok) {
                            this.fallbackSettings = await response.json();
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è fallback –∑–Ω–∞—á–µ–Ω–∏–π:', error);
                    }
                }
                return this.fallbackSettings[key] || null;
            }

            updateCharacterList(characters) {
                console.log('DEBUG: updateCharacterList called with currentUser:', currentUser);
                console.log('DEBUG: Characters received:', characters);
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                this.characterList.innerHTML = '';
                
                if (!characters || !Array.isArray(characters)) {
                    console.error('Characters is not an array:', characters);
                    this.characterList.innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</p>';
                    return;
                }
                
                if (characters.length === 0) {
                    console.log('No characters found');
                    this.characterList.innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</p>';
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                characters.forEach((char, index) => {
                    try {
                        const characterItem = document.createElement('div');
                        characterItem.className = 'character-item';
                        if (index === 0) {
                            characterItem.classList.add('active');
                            this.currentCharacter = char.name;
                        }
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API —Å fallback –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                        const displayName = char.display_name || char.name || '–ü–µ—Ä—Å–æ–Ω–∞–∂';
                        const description = char.description || '–ì–æ—Ç–æ–≤ –∫ –æ–±—â–µ–Ω–∏—é';
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                        const canEdit = currentUser && (char.user_id === currentUser.id || currentUser.is_admin === true);
                        
                        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        console.log(`DEBUG: Character ${char.name}:`, {
                            char_user_id: char.user_id,
                            currentUser_id: currentUser?.id,
                            currentUser_is_admin: currentUser?.is_admin,
                            currentUser_is_admin_type: typeof currentUser?.is_admin,
                            canEdit: canEdit
                        });
                        
                        characterItem.innerHTML = `
                            <div class="character-name">${displayName}</div>
                            <div class="character-description">${description}</div>
                            ${canEdit ? `
                                <div class="character-actions">
                                    <button class="btn-edit" onclick="event.stopPropagation(); editCharacter('${char.name}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
                                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button class="btn-delete" onclick="event.stopPropagation(); deleteCharacter('${char.name}')" title="–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
                                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                            ` : ''}
                        `;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                        characterItem.addEventListener('click', () => {
                            this.selectCharacter(char.name, displayName, characterItem);
                        });
                        
                        this.characterList.appendChild(characterItem);
                    } catch (error) {
                        console.error(`Error processing character ${char.name}:`, error);
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                if (characters.length > 0) {
                    this.updateChatTitle(characters[0].display_name || characters[0].name);
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                    this.currentCharacterData = characters[0];
                    this.currentCharacter = characters[0].name;
                }
                
                console.log(`Successfully loaded ${characters.length} characters`);
            }
            
            async selectCharacter(characterName, displayName, clickedElement) {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                this.characterList.querySelectorAll('.character-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
                clickedElement.classList.add('active');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                this.currentCharacter = characterName;
                this.updateChatTitle(displayName);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –ë–î
                await this.loadCharacterData(characterName);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞)
                if (this.canSaveHistory) {
                    await this.loadChatHistory();
                } else {
                    // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –æ—á–∏—â–∞–µ–º —á–∞—Ç
                    this.clearChat();
                    this.hideClearHistoryButton(); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                }
            }
            
            async loadCharacterData(characterName) {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –ë–î
                    const response = await fetch(`/api/v1/characters/`);
                    if (response.ok) {
                        const characters = await response.json();
                        const character = characters.find(char => 
                            char.name.toLowerCase() === characterName.toLowerCase()
                        );
                        
                        if (character) {
                            console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ '${characterName}' –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ë–î:`, character);
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —á–∞—Ç–µ
                            this.currentCharacterData = character;
                        } else {
                            console.warn(`‚ö†Ô∏è –ü–µ—Ä—Å–æ–Ω–∞–∂ '${characterName}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î`);
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', error);
                }
            }
            
            updateChatTitle(characterName) {
                this.chatTitle.textContent = `–ß–∞—Ç —Å ${characterName}`;
            }
            
            async openPaidGallery() {
                const character = (this.currentCharacter || 'anna').toLowerCase();
                try {
                    const res = await fetch(`/api/v1/paid-gallery/${character}`);
                    if (!res.ok) throw new Error('–ì–∞–ª–µ—Ä–µ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                    const data = await res.json();

                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay';
                    const imagesHtml = data.images && data.images.length
                        ? data.images.map(img => `
                            <div style="width:160px;margin:6px;cursor:pointer">
                                <img src="${img.url}" alt="${img.name}" style="width:160px;height:auto;border-radius:8px;border:1px solid #e0e0e0" onclick="window.open('${img.url}','_blank')">
                                <div style="font-size:12px;color:#666;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${img.name}</div>
                            </div>
                        `).join('')
                        : '<p>–ü–æ–∫–∞ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</p>';

                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3>üíé –ì–∞–ª–µ—Ä–µ—è: ${character}</h3>
                            <div style="display:flex;flex-wrap:wrap;justify-content:flex-start">${imagesHtml}</div>
                            <div class="modal-buttons" style="margin-top:12px">
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                } catch (e) {
                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–ª–∞—Ç–Ω—É—é –≥–∞–ª–µ—Ä–µ—é');
                }
            }


            async sendMessage() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                if (!authToken) {
                    this.showAuthRequiredModal();
                    return;
                }

                const message = this.messageInput.value.trim();
                if (!message) return;

                this.addMessage('user', message);
                this.messageInput.value = '';
                this.setLoading(true);
                this.hideError();

                try {
                    const requestBody = {
                        message: message,
                        character: this.currentCharacter,
                        history: this.messages,
                        session_id: this.sessionId
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º user_id –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                    if (authToken && currentUser) {
                        requestBody.user_id = currentUser.id;
                    }
                    
                    
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                    
                    const data = await response.json();
                    console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API:', data);
                    
                    if (!data || !data.response) {
                        console.error('API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç:', data);
                        throw new Error('API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
                    }
                    
                    const assistantResponse = data.response;
                    this.addMessage('assistant', assistantResponse);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                    if (authToken && currentUser) {
                        await fetchUserInfo();
                    }
                    
                } catch (error) {
                    this.showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                } finally {
                    this.setLoading(false);
                }
            }

            async sendMessageWithImage() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                if (!authToken) {
                    this.showAuthRequiredModal();
                    return;
                }

                const message = this.messageInput.value.trim();
                if (!message) return;

                this.addMessage('user', message);
                this.messageInput.value = '';
                this.setLoading(true);
                this.hideError();
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                this.sendButton.disabled = true;
                this.generateImageButton.disabled = true;

                try {
                    const requestBody = {
                        message: message,
                        character: this.currentCharacter,
                        history: this.messages,
                        session_id: this.sessionId,
                        generate_image: true,
                        image_prompt: message,
                        image_steps: this.generationSettings?.steps || (await this.getFallbackValue('steps'))
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º user_id –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                    if (authToken && currentUser) {
                        requestBody.user_id = currentUser.id;
                    }
                    
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                    
                    const data = await response.json();
                    console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API:', data);
                    
                    if (!data || !data.response) {
                        console.error('API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç:', data);
                        throw new Error('API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
                    }
                    
                    const assistantResponse = data.response;
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
                    this.addMessage('assistant', assistantResponse);
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                    if (data.image_generated && data.image_url) {
                        console.log(`üñºÔ∏è DEBUG: –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${data.image_url}`);
                        this.addImageMessage(data.image_url, data.image_filename);
                    } else {
                        console.log(`‚ö†Ô∏è DEBUG: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ. image_generated: ${data.image_generated}, image_url: ${data.image_url}`);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                    if (authToken && currentUser) {
                        await fetchUserInfo();
                    }
                    
                } catch (error) {
                    this.showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                } finally {
                    this.setLoading(false);
                    // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
                    this.sendButton.disabled = false;
                    this.generateImageButton.disabled = false;
                }
            }

            sendQuickMessage(message) {
                this.messageInput.value = message;
                this.sendMessage();
            }
            
            async sendMessageWithImage() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                if (!authToken) {
                    this.showAuthRequiredModal();
                    return;
                }
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                await this.generatePhoto();
            }
            
            async continueStory() {
                this.messageInput.value = 'continue the story briefly';
                this.sendMessage();
            }
            
            clearChat() {
                const activeCharacter = this.characterList.querySelector('.character-item.active');
                const characterName = activeCharacter ? activeCharacter.querySelector('.character-name').textContent : '–ü–µ—Ä—Å–æ–Ω–∞–∂';
                
                this.chatMessages.innerHTML = `
                    <div class="message assistant">
                    <div class="message-content">
                            –ü—Ä–∏–≤–µ—Ç! –Ø ${characterName}. –ö–∞–∫ –¥–µ–ª–∞? üòä
                        </div>
                    </div>
                `;
                this.messages = [];
                this.sessionId = 'chat_' + Date.now();
                this.hideClearHistoryButton(); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
            }
            
            async generatePhoto() {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–ø—Ç–∞
                this.showPromptModal();
            }
            
            showPromptModal() {
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>üì∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ</h3>
                        <p>–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ:</p>
                        <textarea id="promptInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: beautiful portrait, anime style, detailed, high quality" rows="4"></textarea>
                        <div class="modal-buttons">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                setTimeout(() => {
                    const textarea = modal.querySelector('#promptInput');
                    textarea.focus();
                }, 100);
            }
            
            async generatePhotoWithPrompt() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                if (!authToken) {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    document.querySelector('.modal-overlay').remove();
                    this.showAuthRequiredModal();
                    return;
                }
                
                const promptInput = document.querySelector('#promptInput');
                const prompt = promptInput.value.trim();
                
                if (!prompt) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ');
                    return;
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.querySelector('.modal-overlay').remove();
                
                try {
                this.setLoading(true);
                    this.hideError();

                    const requestBody = {
                        character: this.currentCharacter,
                        prompt: prompt,
                        negative_prompt: this.generationSettings?.negative_prompt || (await this.getFallbackValue('negative_prompt')),
                        width: this.generationSettings?.width || (await this.getFallbackValue('width')),
                        height: this.generationSettings?.height || (await this.getFallbackValue('height')),
                        steps: this.generationSettings?.steps || (await this.getFallbackValue('steps')),
                        cfg_scale: this.generationSettings?.cfg_scale || (await this.getFallbackValue('cfg_scale')),
                        use_default_prompts: false
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º user_id –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                    if (authToken && currentUser) {
                        requestBody.user_id = currentUser.id;
                    }

                    const response = await fetch('/api/v1/generate-image/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    }
                    
                    const data = await response.json();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                    this.addMessage('assistant', `–í–æ—Ç —Ç–≤–æ–µ —Ñ–æ—Ç–æ! üì∏`, data.image_url);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ:', error);
                    this.showError(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ: ${error.message}`);
                } finally {
                    this.setLoading(false);
                }
            }

            addMessage(role, content, imageUrl = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                let messageContent = `<div class="message-content">${content}</div>`;
                if (imageUrl) {
                    messageContent += `<div class="message-image"><img src="${imageUrl}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin-top: 10px;"></div>`;
                }
                
                messageDiv.innerHTML = messageContent;
                this.chatMessages.appendChild(messageDiv);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                this.messages.push({
                    role: role,
                    content: content,
                    imageUrl: imageUrl
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞)
                if (this.canSaveHistory) {
                    this.saveMessageToHistory(role, content, imageUrl);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é" –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
                    if (this.messages.length > 0) {
                        this.showClearHistoryButton();
                    }
                }
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            addImageMessage(imageUrl, filename) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                
                const messageContent = `
                    <div class="message-content">üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${filename}</div>
                    <div class="message-image">
                        <img src="${imageUrl}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin-top: 10px;" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; color: #666; font-style: italic; margin-top: 10px;">
                            ‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                        </div>
                    </div>
                `;
                
                messageDiv.innerHTML = messageContent;
                this.chatMessages.appendChild(messageDiv);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                this.messages.push({
                    role: 'assistant',
                    content: `üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${filename}`,
                    imageUrl: imageUrl
                });
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–∞
            async checkHistoryPermissions() {
                if (!authToken || !currentUser) {
                    this.canSaveHistory = false;
                    return false;
                }
                
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const response = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:', userData);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        if (userData.subscription && userData.subscription.subscription_type) {
                            const subscriptionType = userData.subscription.subscription_type.toLowerCase();
                            this.canSaveHistory = subscriptionType !== 'base';
                            console.log(`üìö –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞: ${this.canSaveHistory ? '–¥–æ—Å—Ç—É–ø–Ω–∞' : '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'} (–ø–æ–¥–ø–∏—Å–∫–∞: ${subscriptionType})`);
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ Base
                            this.canSaveHistory = false;
                            console.log('üìö –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞: –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ)');
                        }
                        
                        return this.canSaveHistory;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
                }
                
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–ø—Ä–µ—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
                this.canSaveHistory = false;
                console.log('üìö –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞: –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏)');
                return false;
            }
            
            async saveMessageToHistory(messageType, content, imageUrl = null, imageFilename = null) {
                if (!this.canSaveHistory || !this.currentCharacter) return;
                
                try {
                    const response = await fetch('/api/v1/chat-history/save-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            character_name: this.currentCharacter,
                            session_id: this.sessionId,
                            message_type: messageType,
                            message_content: content,
                            image_url: imageUrl,
                            image_filename: imageFilename
                        })
                    });
                    
                    if (response.ok) {
                        console.log(`üíæ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏—é: ${messageType}`);
                    } else {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é:', error);
                }
            }
            
            async saveMessageToHistory(messageType, content, imageUrl = null, imageFilename = null) {
                if (!this.canSaveHistory || !this.currentCharacter) {
                    console.log('saveMessageToHistory: –ø—Ä–æ–ø—É—â–µ–Ω–æ - canSaveHistory:', this.canSaveHistory, 'currentCharacter:', this.currentCharacter);
                    return;
                }
                
                console.log('saveMessageToHistory: –Ω–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', {
                    messageType,
                    content: content.substring(0, 50) + '...',
                    character: this.currentCharacter,
                    sessionId: this.sessionId
                });
                
                try {
                    const response = await fetch('/api/v1/chat-history/save-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            character_name: this.currentCharacter,
                            message_type: messageType,
                            message_content: content,
                            session_id: this.sessionId,
                            image_url: imageUrl,
                            image_filename: imageFilename
                        })
                    });
                    
                    console.log('saveMessageToHistory: –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞', response.status, response.statusText);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üíæ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏—é:', data);
                    } else {
                        const errorText = await response.text();
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é:', response.status, errorText);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é:', error);
                }
            }
            
            async loadChatHistory() {
                if (!this.canSaveHistory || !this.currentCharacter) return;
                
                // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º —á–∞—Ç
                this.clearChat();
                
                try {
                    const response = await fetch('/api/v1/chat-history/get-history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            character_name: this.currentCharacter
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.history && data.history.length > 0) {
                            console.log(`üìñ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞: ${data.history.length} —Å–æ–æ–±—â–µ–Ω–∏–π`);
                            
                            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            this.messages = data.history.map(msg => ({
                                role: msg.message_type,
                                content: msg.message_content,
                                imageUrl: msg.image_url,
                                imageFilename: msg.image_filename
                            }));
                            
                            this.updateChatDisplay();
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
                            this.showClearHistoryButton();
                        } else {
                            console.log(`üì≠ –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${this.currentCharacter} –ø—É—Å—Ç–∞`);
                            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
                            this.hideClearHistoryButton();
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:', error);
                }
            }
            
            showClearHistoryButton() {
                const clearHistoryBtn = document.getElementById('clearHistoryBtn');
                if (clearHistoryBtn) {
                    clearHistoryBtn.style.display = 'inline-block';
                }
            }
            
            hideClearHistoryButton() {
                const clearHistoryBtn = document.getElementById('clearHistoryBtn');
                if (clearHistoryBtn) {
                    clearHistoryBtn.style.display = 'none';
                }
            }
            
            async clearChatHistory() {
                if (!this.canSaveHistory || !this.currentCharacter) {
                    showError('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                const confirmed = confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º "${this.currentCharacter}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`);
                if (!confirmed) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/v1/chat-history/clear-history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            character_name: this.currentCharacter
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
                            this.messages = [];
                            this.updateChatDisplay();
                            this.hideClearHistoryButton(); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
                            showSuccess(`–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º "${this.currentCharacter}" –æ—á–∏—â–µ–Ω–∞!`);
                        } else {
                            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞');
                        }
                    } else {
                        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:', error);
                    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞');
                }
            }
            
            updateChatDisplay() {
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                this.chatMessages.innerHTML = '';
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                this.messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.type || message.role}`;
                    
                    let messageContent = `<div class="message-content">${message.content}</div>`;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (message.image_url || message.imageUrl) {
                        const imageUrl = message.image_url || message.imageUrl;
                        messageContent += `<div class="message-image"><img src="${imageUrl}" alt="Generated image" style="max-width: 100%; border-radius: 8px; margin-top: 10px;"></div>`;
                    }
                    
                    messageDiv.innerHTML = messageContent;
                    this.chatMessages.appendChild(messageDiv);
                });
                
                // –£–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
                if (this.messages.length > 0 && this.canSaveHistory) {
                    this.showClearHistoryButton();
                } else {
                    this.hideClearHistoryButton();
                }
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            setLoading(loading) {
                this.loading.style.display = loading ? 'block' : 'none';
                this.sendButton.disabled = loading;
                this.messageInput.disabled = loading;
            }

            showError(message) {
                this.error.textContent = message;
                this.error.style.display = 'block';
            }
                
            hideError() {
                this.error.style.display = 'none';
            }
            
            showAuthRequiredModal() {
                const modal = document.getElementById('authRequiredModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
        let chatApp;
        document.addEventListener('DOMContentLoaded', async () => {
            chatApp = new ChatApp();
            window.chatApp = chatApp; // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ chatApp
            await checkAuth();
            handleOAuthCallback(); // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º OAuth callback
        });

        // –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        async function editCharacter(characterName) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π');
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                const response = await fetch(`/api/v1/characters/${characterName}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                const character = await response.json();
                showEditModal(character);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ' + error.message);
            }
        }

        async function deleteCharacter(characterName) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ "${characterName}"?`)) {
                return;
            }

            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π');
                return;
            }

            try {
                const response = await fetch(`/api/v1/characters/${characterName}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                    chatApp.loadInfo();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ' + error.message);
            }
        }

        function showEditModal(character) {
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
            const existingModal = document.querySelector('.edit-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const modal = document.createElement('div');
            modal.className = 'edit-modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ${character.name}</h3>
                        <button class="close-btn" onclick="this.closest('.edit-modal').remove()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="editName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                        <input type="text" id="editName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞..." value="${character.name || ''}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit;">
                    </div>
                    
                    <div class="form-group">
                        <label for="editPrompt">–ü—Ä–æ–º–ø—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                        <textarea id="editPrompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...">${character.prompt || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAppearance">–í–Ω–µ—à–Ω–æ—Å—Ç—å:</label>
                        <textarea id="editAppearance" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–Ω–µ—à–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...">${character.character_appearance || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editLocation">–õ–æ–∫–∞—Ü–∏—è:</label>
                        <textarea id="editLocation" placeholder="–û–ø–∏—à–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...">${character.location || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="this.closest('.edit-modal').remove()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="saveCharacterEdit('${character.name}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function saveCharacterEdit(characterName) {
            const token = localStorage.getItem('authToken');
            const characterData = {};
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—É—Å—Ç—ã–µ
            const name = document.getElementById('editName').value.trim();
            const prompt = document.getElementById('editPrompt').value.trim();
            const appearance = document.getElementById('editAppearance').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            
            if (name) characterData.name = name;
            if (prompt) characterData.prompt = prompt;
            if (appearance) characterData.character_appearance = appearance;
            if (location) characterData.location = location;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –±—ã–ª–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
            if (Object.keys(characterData).length === 0) {
                alert('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ');
                return;
            }

            try {
                const response = await fetch(`/api/v1/characters/${characterName}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(characterData)
                });

                if (response.ok) {
                    alert('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    document.querySelector('.edit-modal').remove();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                    chatApp.loadInfo();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ' + error.message);
            }
        }

        // –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        let authToken = localStorage.getItem('authToken');
        let refreshToken = localStorage.getItem('refreshToken');
        let currentUser = null;
        
        // –°—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω
        if (authToken) {
            // –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const style = document.createElement('style');
            style.textContent = '#authButtons { display: none !important; } #userButtons { display: block !important; }';
            document.head.appendChild(style);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
        function isAdmin() {
            const result = currentUser && currentUser.is_admin === true;
            console.log('DEBUG: isAdmin() called:', {
                currentUser: currentUser,
                is_admin: currentUser?.is_admin,
                result: result
            });
            return result;
        }

        // –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        async function checkAuth() {
            console.log('checkAuth called, authToken:', authToken ? 'present' : 'missing');
            
            // –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞—Ö (–¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            if (window.chatApp && window.chatApp.loadInfo) {
                await window.chatApp.loadInfo();
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!authToken) {
                showAuthButtons();
                return false;
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
                try {
                    const response = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                if (response.ok) {
                    currentUser = await response.json();
                    console.log('User info received:', currentUser);
                    console.log('DEBUG: currentUser.is_admin =', currentUser.is_admin);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    document.getElementById('usernameDisplay').textContent = currentUser.email;
                    document.getElementById('coinsDisplay').textContent = currentUser.coins || 0;
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    if (window.chatApp && window.chatApp.loadInfo) {
                        await window.chatApp.loadInfo();
                    }
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                    if (window.characterEditor) {
                        console.log('Initializing CharacterEditor with user:', currentUser);
                        window.characterEditor.init(currentUser, authToken);
                    } else {
                        console.error('CharacterEditor not available!');
                    }
                    
                    showUserButtons();
                    console.log('checkAuth: showUserButtons called, currentUser:', currentUser);
                    return true;
                    } else {
                        // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
                        if (refreshToken) {
                            const refreshed = await refreshAccessToken();
                            if (refreshed) {
                                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                                if (window.chatApp && window.chatApp.loadInfo) {
                                    await window.chatApp.loadInfo();
                                }
                                return true;
                            }
                        }
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('refreshToken');
                        authToken = null;
                        refreshToken = null;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('refreshToken');
                    authToken = null;
                    refreshToken = null;
                }
            
            // –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ —Å—é–¥–∞, –∑–Ω–∞—á–∏—Ç —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
            showAuthButtons();
            return false;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token
        async function refreshAccessToken() {
            if (!refreshToken) return false;
            
            try {
                const response = await fetch('/auth/refresh/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    const userResponse = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    currentUser = await userResponse.json();
                    showUserButtons();
                    console.log('refreshAccessToken: showUserButtons called, currentUser:', currentUser);
                    return true;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
            }
            return false;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthButtons() {
            console.log('showAuthButtons called');
            document.getElementById('authButtons').style.display = 'block';
            document.getElementById('userButtons').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function showUserButtons() {
            console.log('showUserButtons called, currentUser:', currentUser);
            console.log('showUserButtons called, authToken:', authToken ? 'present' : 'missing');
            
            const authButtons = document.getElementById('authButtons');
            const userButtons = document.getElementById('userButtons');
            
            console.log('authButtons element:', authButtons);
            console.log('userButtons element:', userButtons);
            
            if (authButtons) {
                authButtons.style.display = 'none';
            }
            if (userButtons) {
                userButtons.style.display = 'block';
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                userButtons.style.setProperty('display', 'block', 'important');
            }
            
            const usernameDisplay = document.getElementById('usernameDisplay');
            const coinsDisplay = document.getElementById('coinsDisplay');
            
            if (usernameDisplay) {
                usernameDisplay.textContent = currentUser ? currentUser.email : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }
            if (coinsDisplay) {
                coinsDisplay.textContent = currentUser ? currentUser.coins || 0 : 0;
            }
            
            console.log('User buttons shown');
        }

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        function showLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            }
        }

        function hideLoginModal() {
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'none';
            }
        }

        function showRegisterModal() {
            const registerModal = document.getElementById('registerModal');
            if (registerModal) {
                registerModal.style.display = 'flex';
            }
        }

        function hideRegisterModal() {
            const registerModal = document.getElementById('registerModal');
            if (registerModal) {
                registerModal.style.display = 'none';
            }
        }

        function showVerificationModal(email, password) {
            console.log('showVerificationModal called with:', email, password);
            const modal = document.getElementById('verificationModal');
            if (!modal) {
                console.error('verificationModal element not found!');
                return;
            }
            modal.style.display = 'flex';
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º email –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            modal.dataset.email = email;
            modal.dataset.password = password;
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –∫–æ–¥–∞
            document.getElementById('verificationCode').value = '';
            console.log('Verification modal should be visible now');
        }

        function hideVerificationModal() {
            document.getElementById('verificationModal').style.display = 'none';
        }

        function showProfileModal() {
            if (currentUser) {
                document.getElementById('profileEmail').textContent = currentUser.email || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('profileId').textContent = currentUser.id || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('profileStatus').textContent = currentUser.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                document.getElementById('profileCoins').textContent = currentUser.coins || 0;
                document.getElementById('profileCreatedAt').textContent = currentUser.created_at ?
                    new Date(currentUser.created_at).toLocaleDateString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('profileModal').style.display = 'flex';
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –º–∞–≥–∞–∑–∏–Ω–∞
        function showShopModal() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–¥–ø–∏—Å–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (authToken) {
                loadSubscriptionStats();
            }
            
            document.getElementById('shopModal').style.display = 'flex';
        }

        function hideShopModal() {
            document.getElementById('shopModal').style.display = 'none';
        }

        async function loadSubscriptionStats() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/v1/subscription/stats/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('usedCredits').textContent = stats.used_credits || 0;
                    document.getElementById('totalCredits').textContent = stats.total_credits || 100;
                    document.getElementById('usedPhotos').textContent = stats.used_photos || 0;
                    document.getElementById('totalPhotos').textContent = stats.total_photos || 10;
                    document.getElementById('daysLeft').textContent = stats.days_left || 30;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
            }
        }

        async function activateSubscription(subscriptionType) {
            if (!authToken) {
                showError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            try {
                const response = await fetch('/api/v1/subscription/activate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        subscription_type: subscriptionType
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(result.message);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    await fetchUserInfo();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    await loadSubscriptionStats();
                } else {
                    const error = await response.json();
                    showError('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        async function activateBaseSubscription() {
            await activateSubscription('base');
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function showCreateCharacterModal() {
            if (!authToken) {
                showError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–Ω–µ—Ç–∞—Ö
            if (currentUser) {
                document.getElementById('userCoinsInfo').textContent = `–£ –≤–∞—Å: ${currentUser.coins || 0} –º–æ–Ω–µ—Ç`;
            }
            
            document.getElementById('createCharacterModal').style.display = 'flex';
        }

        function hideCreateCharacterModal() {
            document.getElementById('createCharacterModal').style.display = 'none';
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('createCharacterForm').reset();
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthRequiredModal() {
            const modal = document.getElementById('authRequiredModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function hideAuthRequiredModal() {
            const modal = document.getElementById('authRequiredModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // –í—Ö–æ–¥
        async function login(email, password) {
            try {
                const response = await fetch('/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    const userResponse = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    currentUser = await userResponse.json();
                    
                    showUserButtons();
                    hideLoginModal();
                    showSuccess('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');
                    return true;
                } else {
                    const error = await response.json();
                    showError('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    return false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                return false;
            }
        }

        // –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email
        async function verifyEmail(email, code) {
            try {
                const password = document.getElementById('verificationModal').dataset.password;
                const response = await fetch('/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        verification_code: code
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);

                    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    const userResponse = await fetch('/auth/me/', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    currentUser = await userResponse.json();

                    showUserButtons();
                    hideVerificationModal();
                    showSuccess('Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    return true;
                } else {
                    const error = await response.json();
                    showError('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'));
                    return false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                return false;
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register(email, password) {
            console.log('register function called with:', email, password);
            try {
                const response = await fetch('/auth/register/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                if (response.ok) {
                    console.log('Registration successful, showing verification modal for:', email);
                    showSuccess('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.');
                    hideRegisterModal();
                    showVerificationModal(email, password);
                    return true;
                } else {
                    const error = await response.json();
                    showError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    return false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                return false;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        async function createCharacter(characterData) {
            if (!authToken) {
                showError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            await fetchUserInfo();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç
            if (!currentUser) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ');
                return;
            }
            
            console.log('DEBUG: –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser);
            console.log('DEBUG: –ú–æ–Ω–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUser.coins);
            
            if (currentUser.coins < 10) {
                showError(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! –£ –≤–∞—Å: ${currentUser.coins}, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ: 10 –º–æ–Ω–µ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.`);
                return;
            }

            try {
                const response = await fetch('/api/v1/characters/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(characterData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${characterData.name}" —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ! –ü–æ—Ç—Ä–∞—á–µ–Ω–æ 10 –º–æ–Ω–µ—Ç.`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    await fetchUserInfo();
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    hideCreateCharacterModal();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
                    if (typeof chatApp !== 'undefined' && chatApp.loadInfo) {
                        chatApp.loadInfo();
                    }
                } else {
                    const error = await response.json();
                    showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        // –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google
        function loginWithGoogle() {
            window.location.href = '/auth/google/';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ OAuth callback
        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const refreshTokenValue = urlParams.get('refresh_token');

            console.log('OAuth callback - accessToken:', accessToken ? 'present' : 'missing');
            console.log('OAuth callback - refreshToken:', refreshTokenValue ? 'present' : 'missing');

            if (accessToken && refreshTokenValue) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω—ã
                localStorage.setItem('authToken', accessToken);
                localStorage.setItem('refreshToken', refreshTokenValue);        
                authToken = accessToken;
                refreshToken = refreshTokenValue;

                console.log('Tokens saved, calling showUserButtons()');

                // –û—á–∏—â–∞–µ–º URL
                window.history.replaceState({}, document.title, window.location.pathname);

                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                showUserButtons();
                showSuccess('–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');

                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                fetchUserInfo();
            } else {
                console.log('OAuth callback - missing tokens, showing auth buttons');
                showAuthButtons();
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        async function fetchUserInfo() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/auth/me/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('usernameDisplay').textContent = currentUser.email;
                    document.getElementById('coinsDisplay').textContent = currentUser.coins || 0;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
            }
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                if (refreshToken) {
                    await fetch('/auth/logout/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            refresh_token: refreshToken
                        })
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
            }
            
            authToken = null;
            refreshToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            showAuthButtons();
            hideProfileModal();
            showSuccess('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;     
            const password = document.getElementById('loginPassword').value;                                                                               
            await login(email, password);        
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Register form submitted');
            const email = document.getElementById('registerEmail').value;  
            const password = document.getElementById('registerPassword').value;
            console.log('Email:', email, 'Password length:', password.length);
            await register(email, password);
        });

        document.getElementById('verificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('verificationModal').dataset.email;
            const code = document.getElementById('verificationCode').value;
            await verifyEmail(email, code);
        });

        document.getElementById('createCharacterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const characterData = {
                name: formData.get('name'),
                personality: formData.get('personality'),
                situation: formData.get('situation'),
                instructions: formData.get('instructions'),
                style: formData.get('style') || '',
                appearance: formData.get('appearance') || '',
                location: formData.get('location') || ''
            };
            await createCharacter(characterData);
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                hideLoginModal();
                hideRegisterModal();
                hideVerificationModal();
                hideProfileModal();
                hideShopModal();
                hideCreateCharacterModal();
            }
        });
    </script>
</body>
</html> 